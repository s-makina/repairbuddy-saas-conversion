module.exports=[62969,a=>{"use strict";var b=a.i(57850),c=a.i(45056),d=a.i(93609),e=a.i(91601),f=a.i(75458),g=a.i(97867),h=a.i(4600),i=a.i(21282),j=a.i(54177),k=a.i(46036),l=a.i(94703),m=a.i(54804),n=a.i(34075),o=a.i(4148);function p(){let a=(0,f.useAuth)(),p=(0,d.useRouter)(),q=(0,d.useParams)(),r=q.business??q.tenant,[s,t]=c.default.useState(!0),[u,v]=c.default.useState(null),[w,x]=c.default.useState(null),[y,z]=c.default.useState(!1),[A,B]=c.default.useState([]),[C,D]=c.default.useState([]),[E,F]=c.default.useState([]),[G,H]=c.default.useState([]),[I,J]=c.default.useState([]),[K,L]=c.default.useState([]),[M,N]=c.default.useState(!1),[O,P]=c.default.useState(null),[Q,R]=c.default.useState(null),[S,T]=c.default.useState("device"),[U,V]=c.default.useState(null),[W,X]=c.default.useState(""),[Y,Z]=c.default.useState("USD"),[$,_]=c.default.useState(null),[aa,ab]=c.default.useState(!0),[ac,ad]=c.default.useState(!1),[ae,af]=c.default.useState(""),[ag,ah]=c.default.useState(""),[ai,aj]=c.default.useState(null),[ak,al]=c.default.useState(""),[am,an]=c.default.useState(0),[ao,ap]=c.default.useState(10),aq=a.can("settings.manage"),ar=c.default.useCallback(async()=>{try{if(t(!0),v(null),"string"!=typeof r||0===r.length)throw Error("Business is missing.");let[a,b,c,d,e,f]=await Promise.all([(0,n.apiFetch)(`/api/${r}/app/repairbuddy/service-price-overrides?limit=200`),(0,n.apiFetch)(`/api/${r}/app/repairbuddy/services?limit=200`),(0,n.apiFetch)(`/api/${r}/app/repairbuddy/taxes?limit=200`),(0,n.apiFetch)(`/api/${r}/app/repairbuddy/devices?limit=200`),(0,n.apiFetch)(`/api/${r}/app/repairbuddy/device-brands?limit=200`),(0,n.apiFetch)(`/api/${r}/app/repairbuddy/device-types?limit=200`)]);B(Array.isArray(a.service_price_overrides)?a.service_price_overrides:[]),D(Array.isArray(b.services)?b.services:[]),F(Array.isArray(c.taxes)?c.taxes:[]),H(Array.isArray(d.devices)?d.devices:[]),J(Array.isArray(e.device_brands)?e.device_brands:[]),L(Array.isArray(f.device_types)?f.device_types:[])}catch(a){if(a instanceof n.ApiError&&428===a.status&&"string"==typeof r&&r.length>0){let a=`/app/${r}/service-price-overrides`;p.replace(`/app/${r}/branches/select?next=${encodeURIComponent(a)}`);return}v(a instanceof Error?a.message:"Failed to load service price overrides.")}finally{t(!1)}},[p,r]);c.default.useEffect(()=>{ar()},[ar]);let as=c.default.useMemo(()=>new Map(C.map(a=>[a.id,a])),[C]),at=c.default.useMemo(()=>new Map(G.map(a=>[a.id,a])),[G]),au=c.default.useMemo(()=>new Map(I.map(a=>[a.id,a])),[I]),av=c.default.useMemo(()=>new Map(K.map(a=>[a.id,a])),[K]),aw=c.default.useMemo(()=>new Map(E.map(a=>[a.id,a])),[E]),ax=c.default.useCallback(a=>"device"===a.scope_type?at.get(a.scope_ref_id)?.model??`Device #${a.scope_ref_id}`:"brand"===a.scope_type?au.get(a.scope_ref_id)?.name??`Brand #${a.scope_ref_id}`:av.get(a.scope_ref_id)?.name??`Type #${a.scope_ref_id}`,[au,at,av]),ay=c.default.useMemo(()=>{let a=ak.trim().toLowerCase();return a?A.filter(b=>{let c=as.get(b.service_id)?.name??String(b.service_id),d=ax(b);return`${b.id} ${c} ${b.scope_type} ${d}`.toLowerCase().includes(a)}):A},[A,ak,ax,as]),az=ay.length,aA=c.default.useMemo(()=>{let a=am*ao,b=a+ao;return ay.slice(a,b)},[ay,am,ao]),aB=c.default.useMemo(()=>"device"===S?G.slice().sort((a,b)=>a.model.localeCompare(b.model)).map(a=>({id:a.id,label:a.model})):"brand"===S?I.slice().sort((a,b)=>a.name.localeCompare(b.name)).map(a=>({id:a.id,label:a.name})):K.slice().sort((a,b)=>a.name.localeCompare(b.name)).map(a=>({id:a.id,label:a.name})),[I,G,S,K]);async function aC(a){if((a.preventDefault(),!y)&&"string"==typeof r&&0!==r.length){if(!aq)return void v("Forbidden.");z(!0),v(null),x(null);try{if("number"!=typeof Q)return void v("Service is required.");if("number"!=typeof U)return void v("Scope value is required.");let a=W.trim(),b=Y.trim().toUpperCase(),c=null,d=null;if(a.length>0){let e=Number(a);if(!Number.isFinite(e))return void v("Price is invalid.");c=Math.round(100*e),d=b.length>0?b:null}let e={service_id:Q,scope_type:S,scope_ref_id:U,price_amount_cents:c,price_currency:d,tax_id:$,is_active:aa};O?(await (0,n.apiFetch)(`/api/${r}/app/repairbuddy/service-price-overrides/${O}`,{method:"PATCH",body:e}),x("Override updated.")):(await (0,n.apiFetch)(`/api/${r}/app/repairbuddy/service-price-overrides`,{method:"POST",body:e}),x("Override created.")),N(!1),an(0),await ar()}catch(a){a instanceof n.ApiError?v(a.message):v(O?"Failed to update override.":"Failed to create override.")}finally{z(!1)}}}async function aD(a){if(!y&&"string"==typeof r&&0!==r.length){var c;if(!aq)return void v("Forbidden.");c={title:"Delete override",message:(0,b.jsxs)("div",{children:["Delete override ",(0,b.jsxs)("span",{className:"font-semibold",children:["#",a.id]}),"?"]}),action:async()=>{z(!0),v(null),x(null);try{await (0,n.apiFetch)(`/api/${r}/app/repairbuddy/service-price-overrides/${a.id}`,{method:"DELETE"}),x("Override deleted."),an(0),await ar()}catch(a){a instanceof n.ApiError?v(a.message):v("Failed to delete override.")}finally{z(!1)}}},af(c.title),ah(c.message),aj(()=>c.action),ad(!0)}}c.default.useEffect(()=>{M&&"number"!=typeof U&&V(aB.length>0?aB[0].id:null)},[M,U,aB]);let aE=c.default.useMemo(()=>[{id:"service",header:"Service",cell:a=>(0,b.jsxs)("div",{className:"min-w-0",children:[(0,b.jsx)("div",{className:"truncate font-semibold text-[var(--rb-text)]",children:as.get(a.service_id)?.name??a.service_id}),(0,b.jsxs)("div",{className:"truncate text-xs text-zinc-600",children:["#",a.id]})]}),className:"min-w-[260px]"},{id:"scope",header:"Scope",cell:a=>(0,b.jsxs)("div",{className:"min-w-0",children:[(0,b.jsx)("div",{className:"text-sm text-zinc-700",children:a.scope_type}),(0,b.jsx)("div",{className:"truncate text-xs text-zinc-500",children:ax(a)})]}),className:"min-w-[220px]"},{id:"price",header:"Price",cell:a=>a.price?(0,b.jsx)("div",{className:"text-sm font-semibold text-[var(--rb-text)] whitespace-nowrap",children:(0,o.formatMoney)({amountCents:a.price.amount_cents,currency:a.price.currency})}):(0,b.jsx)("div",{className:"text-sm text-zinc-600",children:"—"}),className:"whitespace-nowrap"},{id:"tax",header:"Tax",cell:a=>{if("number"!=typeof a.tax_id)return(0,b.jsx)("div",{className:"text-sm text-zinc-600",children:"—"});let c=aw.get(a.tax_id);return(0,b.jsx)("div",{className:"text-sm text-zinc-700",children:c?c.name:a.tax_id})},className:"min-w-[160px]"},{id:"active",header:"Active",className:"whitespace-nowrap",cell:a=>(0,b.jsx)("div",{className:"text-sm text-zinc-700",children:a.is_active?"Yes":"No"})},{id:"actions",header:"",headerClassName:"text-right",className:"whitespace-nowrap text-right",cell:c=>aq?(0,b.jsx)(k.DropdownMenu,{align:"right",trigger:({toggle:a})=>(0,b.jsx)(g.Button,{variant:"ghost",size:"sm",onClick:a,disabled:y,className:"px-2",children:"Actions"}),children:({close:d})=>(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(k.DropdownMenuItem,{onSelect:()=>{d(),aq&&(P(c.id),R(c.service_id),T(c.scope_type),V(c.scope_ref_id),X(c.price?(c.price.amount_cents/100).toFixed(2):""),Z(c.price?.currency??(a.tenant?.currency??"USD").toUpperCase()),_("number"==typeof c.tax_id?c.tax_id:null),ab(!!c.is_active),N(!0),v(null),x(null))},disabled:y,children:"Edit"}),(0,b.jsx)(k.DropdownMenuSeparator,{}),(0,b.jsx)(k.DropdownMenuItem,{destructive:!0,onSelect:()=>{d(),aD(c)},disabled:y,children:"Delete"})]})}):null}],[y,aq,ax,as,aw]);return(0,b.jsx)(e.RequireAuth,{requiredPermission:"settings.manage",children:(0,b.jsxs)("div",{className:"space-y-4",children:[(0,b.jsx)(i.ConfirmDialog,{open:ac,title:ae,message:ag,busy:y,confirmText:"Delete",confirmVariant:"secondary",onCancel:()=>{y||(ad(!1),aj(null))},onConfirm:()=>{ai&&(async()=>{await ai(),ad(!1),aj(null)})()}}),(0,b.jsx)(l.Modal,{open:M,onClose:()=>{y||N(!1)},title:O?"Edit override":"New override",footer:(0,b.jsxs)("div",{className:"flex items-center justify-end gap-2",children:[(0,b.jsx)(g.Button,{variant:"outline",onClick:()=>N(!1),disabled:y,children:"Cancel"}),(0,b.jsx)(g.Button,{disabled:y,type:"submit",form:"rb_service_override_form",children:y?"Saving...":"Save"})]}),children:(0,b.jsxs)("form",{id:"rb_service_override_form",className:"space-y-3",onSubmit:aC,children:[(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("label",{className:"text-sm font-medium",htmlFor:"override_service",children:"Service"}),(0,b.jsx)("select",{id:"override_service",className:"w-full rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white px-3 py-2 text-sm",value:Q??"",onChange:a=>{let b=a.target.value;if(!b)return void R(null);let c=Number(b);R(Number.isFinite(c)?c:null)},disabled:y,children:C.slice().sort((a,b)=>a.name.localeCompare(b.name)).map(a=>(0,b.jsx)("option",{value:a.id,children:a.name},a.id))})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 gap-3 sm:grid-cols-2",children:[(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("label",{className:"text-sm font-medium",htmlFor:"override_scope_type",children:"Scope type"}),(0,b.jsxs)("select",{id:"override_scope_type",className:"w-full rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white px-3 py-2 text-sm",value:S,onChange:a=>{T(a.target.value),V(null)},disabled:y,children:[(0,b.jsx)("option",{value:"device",children:"device"}),(0,b.jsx)("option",{value:"brand",children:"brand"}),(0,b.jsx)("option",{value:"type",children:"type"})]})]}),(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("label",{className:"text-sm font-medium",htmlFor:"override_scope_ref",children:"Scope value"}),(0,b.jsx)("select",{id:"override_scope_ref",className:"w-full rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white px-3 py-2 text-sm",value:U??"",onChange:a=>{let b=a.target.value;if(!b)return void V(null);let c=Number(b);V(Number.isFinite(c)?c:null)},disabled:y,children:aB.map(a=>(0,b.jsx)("option",{value:a.id,children:a.label},`${S}:${a.id}`))})]})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 gap-3 sm:grid-cols-3",children:[(0,b.jsxs)("div",{className:"space-y-1 sm:col-span-2",children:[(0,b.jsx)("label",{className:"text-sm font-medium",htmlFor:"override_price",children:"Override price"}),(0,b.jsx)("input",{id:"override_price",className:"w-full rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white px-3 py-2 text-sm",value:W,onChange:a=>X(a.target.value),disabled:y,inputMode:"decimal",placeholder:"Leave blank to use base"})]}),(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("label",{className:"text-sm font-medium",htmlFor:"override_currency",children:"Currency"}),(0,b.jsx)("input",{id:"override_currency",className:"w-full rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white px-3 py-2 text-sm",value:Y,onChange:a=>Z(a.target.value),disabled:y})]})]}),(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("label",{className:"text-sm font-medium",htmlFor:"override_tax",children:"Tax"}),(0,b.jsxs)("select",{id:"override_tax",className:"w-full rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white px-3 py-2 text-sm",value:$??"",onChange:a=>{let b=a.target.value;if(!b)return void _(null);let c=Number(b);_(Number.isFinite(c)?c:null)},disabled:y,children:[(0,b.jsx)("option",{value:"",children:"(none)"}),E.slice().sort((a,b)=>a.name.localeCompare(b.name)).map(a=>(0,b.jsx)("option",{value:a.id,children:a.name},a.id))]})]}),(0,b.jsxs)("label",{className:"flex items-center gap-2 text-sm",children:[(0,b.jsx)("input",{type:"checkbox",checked:aa,onChange:a=>ab(a.target.checked),disabled:y}),"Active"]})]})}),w?(0,b.jsx)("div",{className:"text-sm text-green-700",children:w}):null,u?(0,b.jsx)("div",{className:"text-sm text-red-600",children:u}):null,(0,b.jsx)(m.ListPageShell,{title:"Service Price Overrides",description:"Override service pricing by device, brand, or type.",actions:(0,b.jsx)(g.Button,{variant:"primary",size:"sm",onClick:function(){aq&&(P(null),R(C.length>0?C[0].id:null),T("device"),V(G.length>0?G[0].id:null),X(""),Z((a.tenant?.currency??"USD").toUpperCase()),_(null),ab(!0),N(!0),v(null),x(null))},disabled:!aq||s||y,children:"New override"}),loading:s,error:null,empty:!s&&!u&&0===A.length,emptyTitle:"No overrides",emptyDescription:"Create overrides to adjust service pricing per device/type/brand.",children:(0,b.jsx)(h.Card,{className:"shadow-none",children:(0,b.jsx)(h.CardContent,{className:"pt-5",children:(0,b.jsx)(j.DataTable,{title:"string"==typeof r?`Service Price Overrides \xb7 ${r}`:"Service Price Overrides",data:aA,loading:s,emptyMessage:"No overrides.",columns:aE,getRowId:a=>a.id,search:{placeholder:"Search overrides..."},server:{query:ak,onQueryChange:a=>{al(a),an(0)},pageIndex:am,onPageIndexChange:an,pageSize:ao,onPageSizeChange:a=>{ap(a),an(0)},totalRows:az}})})})})]})})}a.s(["default",()=>p])}];

//# sourceMappingURL=frontend_src_app_app_%5Btenant%5D_service-price-overrides_page_tsx_d73bcb97._.js.map