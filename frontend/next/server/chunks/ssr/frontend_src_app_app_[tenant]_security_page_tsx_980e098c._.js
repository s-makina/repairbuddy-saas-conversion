module.exports=[93930,a=>{"use strict";var b=a.i(57850),c=a.i(34075),d=a.i(75458),e=a.i(97867),f=a.i(17933),g=a.i(4600),h=a.i(54177),i=a.i(648),j=a.i(26606),k=a.i(73016),l=a.i(92850),m=a.i(45056),n=a.i(93609);function o(){let a=(0,d.useAuth)(),o=(0,n.useParams)(),p=o.business??o.tenant,q=!!(a.user?.otp_enabled&&a.user?.otp_confirmed_at),r=a.can("security.manage"),[s,t]=(0,m.useState)(null),[u,v]=(0,m.useState)(!1),[w,x]=(0,m.useState)(null),[y,z]=(0,m.useState)([]),[A,B]=(0,m.useState)(!1),[C,D]=(0,m.useState)([]),[E,F]=(0,m.useState)(7),[G,H]=(0,m.useState)(60),[I,J]=(0,m.useState)(30),[K,L]=(0,m.useState)(10),[M,N]=(0,m.useState)(15),[O,P]=(0,m.useState)(null),[Q,R]=(0,m.useState)(!1),[S,T]=(0,m.useState)(null),[U,V]=(0,m.useState)(""),[W,X]=(0,m.useState)(0),[Y,Z]=(0,m.useState)(10),[$,_]=(0,m.useState)([]),[aa,ab]=(0,m.useState)(!1),[ac,ad]=(0,m.useState)(null),[ae,af]=(0,m.useState)(""),[ag,ah]=(0,m.useState)(1),[ai,aj]=(0,m.useState)(25),[ak,al]=(0,m.useState)(1),[am,an]=(0,m.useState)(0),[ao,ap]=(0,m.useState)(null),[aq,ar]=(0,m.useState)(""),[as,at]=(0,m.useState)(""),[au,av]=(0,m.useState)(""),[aw,ax]=(0,m.useState)(null),[ay,az]=(0,m.useState)(null),[aA,aB]=(0,m.useState)(!1),aC=(0,m.useMemo)(()=>ao?.otpauth_uri?ao.otpauth_uri:null,[ao?.otpauth_uri]);(0,m.useEffect)(()=>{ap(null),ar(""),at(""),av(""),ax(null),az(null)},[q]),(0,m.useEffect)(()=>{r&&"string"==typeof p&&0!==p.length&&(x(null),v(!0),(0,c.apiFetch)(`/api/${p}/app/security-settings`).then(a=>{t(a.settings),D(Array.isArray(a.settings.mfa_required_roles)?a.settings.mfa_required_roles:[]),F(a.settings.mfa_grace_period_days??7),H(a.settings.session_idle_timeout_minutes??60),J(a.settings.session_max_lifetime_days??30),L(a.settings.lockout_max_attempts??10),N(a.settings.lockout_duration_minutes??15)}).catch(a=>{x(a instanceof Error?a.message:"Failed to load security settings.")}).finally(()=>v(!1)))},[r,p]),(0,m.useEffect)(()=>{r&&"string"==typeof p&&0!==p.length&&(B(!0),(0,c.apiFetch)(`/api/${p}/app/roles`).then(a=>z(Array.isArray(a.roles)?a.roles:[])).catch(()=>z([])).finally(()=>B(!1)))},[r,p]),(0,m.useEffect)(()=>{r&&"string"==typeof p&&0!==p.length&&(T(null),R(!0),(0,c.apiFetch)(`/api/${p}/app/security/compliance`).then(a=>P(a.mfa)).catch(a=>T(a instanceof Error?a.message:"Failed to load compliance.")).finally(()=>R(!1)))},[r,p,q]),(0,m.useEffect)(()=>{if(!r||"string"!=typeof p||0===p.length)return;ad(null),ab(!0);let a=new URLSearchParams;ae.trim().length>0&&a.set("type",ae.trim()),a.set("page",String(ag)),a.set("per_page",String(ai)),(0,c.apiFetch)(`/api/${p}/app/audit-events?${a.toString()}`).then(a=>{_(Array.isArray(a.events)?a.events:[]),al("number"==typeof a.meta?.last_page?a.meta.last_page:1),an("number"==typeof a.meta?.total?a.meta.total:Array.isArray(a.events)?a.events.length:0)}).catch(a=>ad(a instanceof Error?a.message:"Failed to load audit events.")).finally(()=>ab(!1))},[r,p,ae,ag,ai]);let aD=(0,m.useMemo)(()=>(Array.isArray(O?.non_compliant_users)?O?.non_compliant_users:[]).map(a=>{let b=a.roleModel?.name??a.role_model?.name??"(none)",c=!!(a.otp_enabled&&a.otp_confirmed_at);return{id:a.id,name:a.name,email:a.email??"",roleName:b,compliant:c}}),[O?.non_compliant_users]),aE=(0,m.useMemo)(()=>{let a=U.trim().toLowerCase();return a?aD.filter(b=>`${b.id} ${b.name} ${b.email} ${b.roleName}`.toLowerCase().includes(a)):aD},[U,aD]),aF=aE.length,aG=(0,m.useMemo)(()=>{let a=W*Y,b=a+Y;return aE.slice(a,b)},[aE,W,Y]),aH=(0,m.useMemo)(()=>[{id:"user",header:"User",cell:a=>(0,b.jsxs)("div",{className:"min-w-0",children:[(0,b.jsx)("div",{className:"truncate font-semibold text-[var(--rb-text)]",children:a.name}),(0,b.jsx)("div",{className:"truncate text-xs text-zinc-600",children:a.email})]}),className:"min-w-[240px]"},{id:"role",header:"Role",cell:a=>(0,b.jsx)("div",{className:"text-sm text-zinc-700",children:a.roleName}),className:"min-w-[200px]"},{id:"otp",header:"OTP",cell:a=>a.compliant?(0,b.jsx)(f.Badge,{variant:"success",children:"Enabled"}):(0,b.jsx)(f.Badge,{variant:"danger",children:"Missing"}),className:"whitespace-nowrap"}],[]),aI=(0,m.useMemo)(()=>$,[$]),aJ=(0,m.useMemo)(()=>[{id:"when",header:"When",cell:a=>(0,b.jsx)("div",{className:"text-xs text-zinc-600",children:a.created_at??""}),className:"whitespace-nowrap"},{id:"type",header:"Type",cell:a=>(0,b.jsx)("div",{className:"font-semibold text-[var(--rb-text)]",children:a.type}),className:"min-w-[240px]"},{id:"source",header:"Source",cell:a=>(0,b.jsx)("div",{className:"text-zinc-700",children:a.source}),className:"whitespace-nowrap"},{id:"user",header:"User",cell:a=>(0,b.jsx)("div",{className:"text-zinc-700",children:a.email??(a.user_id?`#${a.user_id}`:"")}),className:"min-w-[220px]"},{id:"ip",header:"IP",cell:a=>(0,b.jsx)("div",{className:"text-zinc-700",children:a.ip??""}),className:"whitespace-nowrap"}],[]);async function aK(a){if(a.preventDefault(),!r||"string"!=typeof p||0===p.length)return;x(null),v(!0);let b=Array.isArray(C)?C.filter(a=>Number.isFinite(a)&&a>0):[];try{let a=await (0,c.apiFetch)(`/api/${p}/app/security-settings`,{method:"PUT",body:{mfa_required_roles:b,mfa_grace_period_days:E,session_idle_timeout_minutes:G,session_max_lifetime_days:I,lockout_max_attempts:K,lockout_duration_minutes:M}});t(a.settings)}catch(a){a instanceof c.ApiError?x(a.message):x("Failed to save security settings.")}finally{v(!1)}}async function aL(){if(r&&"string"==typeof p&&0!==p.length){x(null),v(!0);try{await (0,c.apiFetch)(`/api/${p}/app/security/force-logout`,{method:"POST"})}catch(a){a instanceof c.ApiError?x(a.message):x("Failed to force logout.")}finally{v(!1)}}}async function aM(){az(null),ax(null),aB(!0);try{let a=await (0,c.apiFetch)("/api/auth/otp/setup",{method:"POST"});ap(a)}catch(a){a instanceof c.ApiError?az(a.message):az("Failed to start OTP setup.")}finally{aB(!1)}}async function aN(b){b.preventDefault(),az(null),ax(null),aB(!0);try{await (0,c.apiFetch)("/api/auth/otp/confirm",{method:"POST",body:{code:aq}}),ax("OTP enabled."),await a.refresh()}catch(a){a instanceof c.ApiError?az(a.message):az("Failed to confirm OTP.")}finally{aB(!1)}}async function aO(b){b.preventDefault(),az(null),ax(null),aB(!0);try{await (0,c.apiFetch)("/api/auth/otp/disable",{method:"POST",body:{password:as,code:au}}),ax("OTP disabled."),await a.refresh()}catch(a){a instanceof c.ApiError?az(a.message):az("Failed to disable OTP.")}finally{aB(!1)}}return(0,b.jsxs)("div",{className:"space-y-6",children:[(0,b.jsx)(i.PageHeader,{title:"Security",description:"Manage multi-factor authentication (OTP)."}),aw?(0,b.jsx)("div",{className:"text-sm text-green-700",children:aw}):null,ay?(0,b.jsx)("div",{className:"text-sm text-red-600",children:ay}):null,(0,b.jsxs)(k.Tabs,{defaultValue:r?"policies":"mfa",children:[(0,b.jsxs)(k.TabsList,{children:[(0,b.jsx)(k.TabsTrigger,{value:"mfa",children:"MFA / OTP"}),r?(0,b.jsx)(k.TabsTrigger,{value:"policies",children:"Policies"}):null,r?(0,b.jsx)(k.TabsTrigger,{value:"compliance",children:"Compliance"}):null,r?(0,b.jsx)(k.TabsTrigger,{value:"audit",children:"Audit Log"}):null]}),(0,b.jsx)(k.TabsContent,{value:"mfa",children:(0,b.jsx)(g.Card,{className:"shadow-none",children:(0,b.jsxs)(g.CardContent,{className:"pt-5",children:[(0,b.jsx)("div",{className:"text-sm font-semibold text-[var(--rb-text)]",children:"Multi-factor authentication (OTP)"}),(0,b.jsxs)("div",{className:"mt-1 text-sm text-zinc-600",children:["Status: ",q?"Enabled":"Disabled"]}),q?(0,b.jsxs)("form",{className:"mt-4 space-y-3",onSubmit:aO,children:[(0,b.jsx)("div",{className:"text-sm text-zinc-700",children:"To disable OTP, confirm your password and an OTP code."}),(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("label",{className:"text-sm font-medium",htmlFor:"disable_password",children:"Password"}),(0,b.jsx)("input",{className:"w-full rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white px-3 py-2 text-sm",id:"disable_password",value:as,onChange:a=>at(a.target.value),type:"password",autoComplete:"current-password",required:!0})]}),(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("label",{className:"text-sm font-medium",htmlFor:"disable_code",children:"OTP code"}),(0,b.jsx)("input",{className:"w-full rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white px-3 py-2 text-sm",id:"disable_code",value:au,onChange:a=>av(a.target.value.replace(/\D/g,"").slice(0,6)),type:"text",inputMode:"numeric",pattern:"[0-9]{6}",maxLength:6,required:!0})]}),(0,b.jsx)(e.Button,{variant:"outline",type:"submit",disabled:aA,children:aA?"Disabling...":"Disable OTP"})]}):(0,b.jsx)("div",{className:"mt-4 space-y-4",children:ao?(0,b.jsxs)("div",{className:"space-y-3",children:[(0,b.jsx)("div",{className:"text-sm text-zinc-700",children:"Add this account in your authenticator app using the secret below."}),ao.otpauth_uri?(0,b.jsxs)("div",{className:"rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white p-4",children:[(0,b.jsx)("div",{className:"text-xs font-semibold text-zinc-500",children:"Scan QR code"}),(0,b.jsx)("div",{className:"mt-3 flex items-center justify-center",children:(0,b.jsx)("div",{className:"rounded-[12px] bg-white p-3 ring-1 ring-[var(--rb-border)]",children:(0,b.jsx)(l.default,{value:ao.otpauth_uri,size:176})})}),(0,b.jsx)("div",{className:"mt-3 text-xs text-zinc-600",children:"If you can’t scan, you can still add it manually using the secret below."})]}):null,(0,b.jsxs)("div",{className:"rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-[var(--rb-surface-muted)] p-3",children:[(0,b.jsx)("div",{className:"text-xs font-semibold text-zinc-500",children:"Secret"}),(0,b.jsx)("div",{className:"mt-1 font-mono text-sm break-all",children:ao.secret})]}),aC?(0,b.jsx)("a",{className:"text-sm text-[var(--rb-text)] underline",href:aC,children:"Open in authenticator"}):null,(0,b.jsxs)("form",{className:"space-y-2",onSubmit:aN,children:[(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("label",{className:"text-sm font-medium",htmlFor:"otp_code",children:"Enter 6-digit code"}),(0,b.jsx)("input",{className:"w-full rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white px-3 py-2 text-sm",id:"otp_code",value:aq,onChange:a=>ar(a.target.value.replace(/\D/g,"").slice(0,6)),type:"text",inputMode:"numeric",pattern:"[0-9]{6}",maxLength:6,required:!0})]}),(0,b.jsx)(e.Button,{type:"submit",disabled:aA,children:aA?"Confirming...":"Confirm OTP"})]})]}):(0,b.jsx)(e.Button,{type:"button",onClick:()=>void aM(),disabled:aA,children:aA?"Starting...":"Enable OTP"})})]})})}),r?(0,b.jsx)(k.TabsContent,{value:"policies",children:!u||s||w?(0,b.jsx)(g.Card,{className:"shadow-none",children:(0,b.jsxs)(g.CardContent,{className:"pt-5",children:[(0,b.jsx)("div",{className:"text-sm font-semibold text-[var(--rb-text)]",children:"Tenant security policies"}),(0,b.jsx)("div",{className:"mt-1 text-sm text-zinc-600",children:"Configure enforcement rules for all users in this business."}),w?(0,b.jsx)("div",{className:"mt-3 text-sm text-red-600",children:w}):null,(0,b.jsxs)("form",{className:"mt-4 grid gap-3",onSubmit:aK,children:[(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("label",{className:"text-sm font-medium",htmlFor:"mfa_roles",children:"MFA required roles"}),(0,b.jsxs)("div",{className:"rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white p-3",children:[A?(0,b.jsx)("div",{className:"grid gap-2 md:grid-cols-2",children:Array.from({length:6}).map((a,c)=>(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)(j.Skeleton,{className:"h-4 w-4 rounded-[4px]"}),(0,b.jsx)(j.Skeleton,{className:"h-4 w-32 rounded-[var(--rb-radius-sm)]"})]},c))}):null,A||0!==y.length?null:(0,b.jsx)("div",{className:"text-sm text-zinc-600",children:"No roles found."}),!A&&y.length>0?(0,b.jsx)("div",{className:"grid gap-2 md:grid-cols-2",children:y.map(a=>{let c=C.includes(a.id);return(0,b.jsxs)("label",{className:"flex items-center gap-2 text-sm text-zinc-700",children:[(0,b.jsx)("input",{type:"checkbox",checked:c,disabled:u,onChange:b=>{D(b.target.checked?Array.from(new Set([...C,a.id])):C.filter(b=>b!==a.id))}}),(0,b.jsx)("span",{className:"min-w-0 truncate",children:a.name})]},a.id)})}):null]}),s?.mfa_enforce_after?(0,b.jsxs)("div",{className:"text-xs text-zinc-600",children:["Enforce after: ",s.mfa_enforce_after]}):null]}),(0,b.jsxs)("div",{className:"grid gap-3 md:grid-cols-2",children:[(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("label",{className:"text-sm font-medium",htmlFor:"mfa_grace",children:"MFA grace period (days)"}),(0,b.jsx)("input",{id:"mfa_grace",className:"w-full rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white px-3 py-2 text-sm",value:String(E),onChange:a=>F(Number(a.target.value)),type:"number",min:0,max:365,disabled:u})]}),(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("label",{className:"text-sm font-medium",htmlFor:"idle_timeout",children:"Session idle timeout (minutes)"}),(0,b.jsx)("input",{id:"idle_timeout",className:"w-full rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white px-3 py-2 text-sm",value:String(G),onChange:a=>H(Number(a.target.value)),type:"number",min:5,max:1440,disabled:u})]}),(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("label",{className:"text-sm font-medium",htmlFor:"max_life",children:"Session max lifetime (days)"}),(0,b.jsx)("input",{id:"max_life",className:"w-full rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white px-3 py-2 text-sm",value:String(I),onChange:a=>J(Number(a.target.value)),type:"number",min:1,max:365,disabled:u})]}),(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("label",{className:"text-sm font-medium",htmlFor:"lockout_attempts",children:"Lockout max attempts"}),(0,b.jsx)("input",{id:"lockout_attempts",className:"w-full rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white px-3 py-2 text-sm",value:String(K),onChange:a=>L(Number(a.target.value)),type:"number",min:1,max:100,disabled:u})]}),(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("label",{className:"text-sm font-medium",htmlFor:"lockout_minutes",children:"Lockout duration (minutes)"}),(0,b.jsx)("input",{id:"lockout_minutes",className:"w-full rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white px-3 py-2 text-sm",value:String(M),onChange:a=>N(Number(a.target.value)),type:"number",min:1,max:1440,disabled:u})]})]}),(0,b.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[(0,b.jsx)(e.Button,{type:"submit",disabled:u,children:u?"Saving...":"Save policies"}),(0,b.jsx)(e.Button,{variant:"outline",type:"button",onClick:()=>void aL(),disabled:u,children:"Force logout all users"})]})]})]})}):(0,b.jsx)(function(){return(0,b.jsx)(g.Card,{className:"shadow-none",children:(0,b.jsxs)(g.CardContent,{className:"pt-5",children:[(0,b.jsx)(j.Skeleton,{className:"h-4 w-52 rounded-[var(--rb-radius-sm)]"}),(0,b.jsx)(j.Skeleton,{className:"mt-2 h-4 w-80 rounded-[var(--rb-radius-sm)]"}),(0,b.jsxs)("div",{className:"mt-4 space-y-3",children:[(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)(j.Skeleton,{className:"h-4 w-40 rounded-[var(--rb-radius-sm)]"}),(0,b.jsx)("div",{className:"rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white p-3",children:(0,b.jsx)("div",{className:"grid gap-2 md:grid-cols-2",children:Array.from({length:6}).map((a,c)=>(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)(j.Skeleton,{className:"h-4 w-4 rounded-[4px]"}),(0,b.jsx)(j.Skeleton,{className:"h-4 w-32 rounded-[var(--rb-radius-sm)]"})]},c))})})]}),(0,b.jsx)("div",{className:"grid gap-3 md:grid-cols-2",children:Array.from({length:4}).map((a,c)=>(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)(j.Skeleton,{className:"h-4 w-48 rounded-[var(--rb-radius-sm)]"}),(0,b.jsx)(j.Skeleton,{className:"h-9 w-full rounded-[var(--rb-radius-sm)]"})]},c))}),(0,b.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[(0,b.jsx)(j.Skeleton,{className:"h-9 w-28 rounded-[var(--rb-radius-sm)]"}),(0,b.jsx)(j.Skeleton,{className:"h-9 w-44 rounded-[var(--rb-radius-sm)]"})]})]})]})})},{})}):null,r?(0,b.jsx)(k.TabsContent,{value:"compliance",children:(0,b.jsx)(g.Card,{className:"shadow-none",children:(0,b.jsxs)(g.CardContent,{className:"pt-5",children:[(0,b.jsx)("div",{className:"text-sm font-semibold text-[var(--rb-text)]",children:"MFA compliance"}),(0,b.jsx)("div",{className:"mt-1 text-sm text-zinc-600",children:"Users in required roles who have not confirmed OTP."}),S?(0,b.jsx)("div",{className:"mt-3 text-sm text-red-600",children:S}):null,(0,b.jsxs)("div",{className:"mt-3 flex flex-wrap items-center gap-2 text-sm",children:[(0,b.jsxs)(f.Badge,{variant:"default",children:["In scope: ",Q?"…":O?.total_in_scope??0]}),(0,b.jsxs)(f.Badge,{variant:"success",children:["Compliant: ",Q?"…":O?.compliant??0]}),(0,b.jsxs)(f.Badge,{variant:"danger",children:["Non-compliant: ",Q?"…":O?.non_compliant??0]})]}),(0,b.jsx)("div",{className:"mt-4",children:(0,b.jsx)(h.DataTable,{title:"Non-compliant users",data:aG,loading:Q,emptyMessage:"No non-compliant users.",columns:aH,getRowId:a=>String(a.id),search:{placeholder:"Search users..."},server:{query:U,onQueryChange:a=>{V(a),X(0)},pageIndex:W,onPageIndexChange:X,pageSize:Y,onPageSizeChange:a=>{Z(a),X(0)},totalRows:aF}})})]})})}):null,r?(0,b.jsx)(k.TabsContent,{value:"audit",children:(0,b.jsx)(g.Card,{className:"shadow-none",children:(0,b.jsxs)(g.CardContent,{className:"pt-5",children:[(0,b.jsx)("div",{className:"text-sm font-semibold text-[var(--rb-text)]",children:"Security audit log"}),(0,b.jsx)("div",{className:"mt-1 text-sm text-zinc-600",children:"Tenant-scoped authentication and admin actions."}),ac?(0,b.jsx)("div",{className:"mt-3 text-sm text-red-600",children:ac}):null,(0,b.jsx)("div",{className:"mt-4",children:(0,b.jsx)(h.DataTable,{title:"Audit events",data:aI,loading:aa,emptyMessage:"No events.",columns:aJ,getRowId:a=>`${a.source}:${a.id}`,search:{placeholder:"Filter by type (e.g. login_success)"},server:{query:ae,onQueryChange:a=>{af(a),ah(1)},pageIndex:ag-1,onPageIndexChange:a=>ah(a+1),pageSize:ai,onPageSizeChange:a=>{aj(a),ah(1)},totalRows:am}})})]})})}):null]})]})}a.s(["default",()=>o])}];

//# sourceMappingURL=frontend_src_app_app_%5Btenant%5D_security_page_tsx_980e098c._.js.map