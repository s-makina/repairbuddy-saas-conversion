module.exports=[17211,a=>{"use strict";var b=a.i(57850),c=a.i(45056),d=a.i(59843),e=a.i(91601),f=a.i(25533),g=a.i(75385),h=a.i(17933),i=a.i(97867),j=a.i(4600),k=a.i(21282),l=a.i(54177),m=a.i(29054),n=a.i(94703),o=a.i(34075),p=a.i(56264),q=a.i(75458);let r="admin.billing.builder.draft.v1";function s(a,b){let c=Number.isFinite(a)?a:0,d=(b||"").toUpperCase()||"XXX";return`${(c/100).toFixed(2)} ${d}`}function t({steps:a,step:c,maxStepAllowed:d,onStepChange:e}){let f=Math.max(0,Math.min(c,a.length-1)),g=Math.max(1,a.length-1);return(0,b.jsxs)(j.Card,{className:"shadow-none lg:sticky lg:top-6 lg:self-start",children:[(0,b.jsx)(j.CardHeader,{className:"pb-3",children:(0,b.jsxs)("div",{className:"flex items-start justify-between gap-4",children:[(0,b.jsxs)("div",{className:"min-w-0",children:[(0,b.jsx)(j.CardTitle,{className:"text-base",children:"Builder steps"}),(0,b.jsx)(j.CardDescription,{children:"Follow the steps to build and create a plan."})]}),(0,b.jsxs)("div",{className:"text-right",children:[(0,b.jsxs)("div",{className:"text-xs text-zinc-500",children:["Step ",f+1," of ",a.length]}),(0,b.jsx)("div",{className:"mt-2",children:(0,b.jsx)(h.Badge,{variant:f===a.length-1?"info":"default",children:a[f]??""})})]})]})}),(0,b.jsxs)(j.CardContent,{className:"space-y-4",children:[(0,b.jsx)("div",{className:"h-2 w-full overflow-hidden rounded-full bg-[var(--rb-border)]",children:(0,b.jsx)("div",{className:"h-full bg-[linear-gradient(90deg,var(--rb-blue),var(--rb-orange))]",style:{width:`${Math.round(f/g*100)}%`}})}),(0,b.jsx)("nav",{"aria-label":"Builder steps",className:"space-y-1",children:a.map((a,c)=>{let g=c===f,h=c<f,i=c<=d;return(0,b.jsx)("button",{type:"button",disabled:!i,onClick:()=>{i&&e(c)},className:"w-full rounded-[var(--rb-radius-md)] border px-3 py-2 text-left transition disabled:cursor-not-allowed disabled:opacity-60 "+(g?"border-[color:color-mix(in_srgb,var(--rb-blue),white_65%)] bg-[color:color-mix(in_srgb,var(--rb-blue),white_92%)]":h?"border-[color:color-mix(in_srgb,var(--rb-blue),white_75%)] bg-white hover:bg-[var(--rb-surface-muted)]":"border-[var(--rb-border)] bg-white hover:bg-[var(--rb-surface-muted)]"),children:(0,b.jsxs)("div",{className:"flex items-center gap-3",children:[(0,b.jsx)("div",{className:"flex h-7 w-7 shrink-0 items-center justify-center rounded-full border text-xs font-semibold "+(g?"border-[var(--rb-blue)] bg-[var(--rb-blue)] text-white":h?"border-[var(--rb-blue)] bg-[color:color-mix(in_srgb,var(--rb-blue),white_90%)] text-[var(--rb-blue)]":"border-[var(--rb-border)] bg-white text-zinc-600"),children:h?(0,b.jsx)("svg",{viewBox:"0 0 24 24",className:"h-4 w-4",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":"true",children:(0,b.jsx)("path",{d:"M20 6L9 17l-5-5"})}):c+1}),(0,b.jsxs)("div",{className:"min-w-0",children:[(0,b.jsx)("div",{className:"text-sm font-semibold text-[var(--rb-text)]",children:a}),(0,b.jsx)("div",{className:"mt-0.5 text-xs text-zinc-600",children:0===c?"Plan details.":1===c?"Price points.":2===c?"Entitlements.":"Create & activate."})]})]})},a)})})]})]})}function u(){let a=(0,f.useDashboardHeader)(),u=(0,q.useAuth)(),[v,w]=(0,c.useState)(0),[x,y]=(0,c.useState)(!0),[z,A]=(0,c.useState)(null),[B,C]=(0,c.useState)(null),[D,E]=(0,c.useState)(0),[F,G]=(0,c.useState)([]),[H,I]=(0,c.useState)([]),[J,K]=(0,c.useState)([]),[L,M]=(0,c.useState)([]),[N,O]=(0,c.useState)(null),[P,Q]=(0,c.useState)(null),[R,S]=(0,c.useState)(!1),[T,U]=(0,c.useState)(null),V=u.can("admin.billing.write"),[W,X]=(0,c.useState)(null),[Y,Z]=(0,c.useState)(""),[$,_]=(0,c.useState)(""),[aa,ab]=(0,c.useState)(""),[ac,ad]=(0,c.useState)(!0),[ae,af]=(0,c.useState)(!1),[ag,ah]=(0,c.useState)(!1),[ai,aj]=(0,c.useState)(null),[ak,al]=(0,c.useState)(null),[am,an]=(0,c.useState)("EUR"),[ao,ap]=(0,c.useState)(null),[aq,ar]=(0,c.useState)("month"),[as,at]=(0,c.useState)("0.00"),[au,av]=(0,c.useState)(""),[aw,ax]=(0,c.useState)(!1),[ay,az]=(0,c.useState)(!1),[aA,aB]=(0,c.useState)(null),[aC,aD]=(0,c.useState)({}),[aE,aF]=(0,c.useState)({}),[aG,aH]=(0,c.useState)({}),[aI,aJ]=(0,c.useState)({}),[aK,aL]=(0,c.useState)(!1),[aM,aN]=(0,c.useState)(null),[aO,aP]=(0,c.useState)(!1),[aQ,aR]=(0,c.useState)(!1),[aS,aT]=(0,c.useState)(""),aU=["Details","Prices","Entitlements","Review"];(0,c.useEffect)(()=>(a.setHeader({breadcrumb:"Admin / Billing",title:"Plan builder",subtitle:"Build a plan and create it at the end",actions:(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)(d.default,{href:"/admin/billing/plans",children:(0,b.jsx)(i.Button,{variant:"outline",size:"sm",children:"Back to plans"})}),(0,b.jsx)(i.Button,{variant:"outline",size:"sm",onClick:()=>E(a=>a+1),disabled:x,children:"Refresh"})]})}),()=>a.setHeader(null)),[a,x]),(0,c.useEffect)(()=>{try{return}catch{try{window.localStorage.removeItem(r)}catch{}}},[aU.length]),(0,c.useEffect)(()=>{let a=!0;return async function(){try{y(!0),A(null),C(null);let b=await (0,p.getBillingCatalog)({includeInactive:!0});if(!a)return;let c=Array.isArray(b.entitlement_definitions)?b.entitlement_definitions:[];G(c);let d=Array.isArray(b.billing_intervals)?b.billing_intervals:[];I(d);try{let b=await (0,o.apiFetch)("/api/admin/settings");if(!a)return;let c=(Array.isArray(b.currencies)?b.currencies:[]).filter(a=>!!a?.is_active).map(a=>({code:String(a.code??"").trim().toUpperCase(),name:String(a.name??"").trim(),symbol:String(a.symbol??"").trim()})).filter(a=>3===a.code.length).sort((a,b)=>a.code.localeCompare(b.code));K(c)}catch(b){if(!a)return;K([])}}catch(b){if(!a)return;A(b instanceof Error?b.message:"Failed to load billing catalog."),G([]),I([]),K([])}finally{if(!a)return;y(!1)}}(),()=>{a=!1}},[D]);let aV=(0,c.useMemo)(()=>new Set(J.map(a=>a.code)),[J]),aW=(0,c.useMemo)(()=>[],[]),aX=(0,c.useMemo)(()=>({}),[aW]),aY=(0,c.useMemo)(()=>(Array.isArray(F)?F:[]).slice().sort((a,b)=>(a.id??0)-(b.id??0)),[F]);(0,c.useEffect)(()=>{let a={},b={},c={},d={};for(let e of aY){let f=aX[e.id]??null;a[e.id]=!!f,b[e.id]=f?f.value_json:null;let g=String(e.value_type??"json");"boolean"===g&&f&&(b[e.id]=!0),"boolean"!==g&&"integer"!==g&&(c[e.id]=JSON.stringify(f?f.value_json??null:null,null,2),d[e.id]=null)}aD(a),aF(b),aH(c),aJ(d)},[aY,aX]),(0,c.useMemo)(()=>{let a=[];for(let b of aY){if(!aC[b.id])continue;let c=String(b.value_type??"json");a.push({entitlement_definition_id:b.id,value_json:"boolean"===c||(aE[b.id]??null)})}return{plan:{name:Y.trim(),code:$.trim()||null,description:aa.trim()||null,is_active:!!ac},prices:L.map(a=>({currency:String(a.currency).toUpperCase(),interval:String(a.interval).toLowerCase(),amount_cents:a.amount_cents,trial_days:a.trial_days,is_default:!!a.is_default})),entitlements:a}},[aY,aC,aE,ac,$,aa,Y,L]);let aZ=(0,c.useMemo)(()=>{let a=(Array.isArray(L)?L:[]).map(a=>({...a,currency:String(a.currency).trim().toUpperCase(),interval:String(a.interval||"").trim().toLowerCase()||"month",billing_interval_id:"number"==typeof a.billing_interval_id&&Number.isFinite(a.billing_interval_id)?a.billing_interval_id:null,amount_cents:Number.isFinite(a.amount_cents)?Math.max(0,Math.trunc(a.amount_cents)):0}));if(0===a.length)return{ok:!1,message:"Add at least one price."};let b={};for(let c of a){let a=`${c.currency}|${c.interval}`;b[a]||(b[a]={total:0,defaults:0}),b[a].total+=1,c.is_default&&(b[a].defaults+=1)}for(let[a,c]of Object.entries(b)){if(0===c.defaults)return{ok:!1,message:`Set a default price for ${a}.`};if(c.defaults>1)return{ok:!1,message:`Only one default price allowed for ${a}.`}}return{ok:!0,message:null}},[L]),a$=(0,c.useMemo)(()=>0===Y.trim().length?0:aZ.ok?aU.length-1:1,[Y,aZ.ok,aU.length]);async function a_(){(2!==v||!V||await a5())&&w(a=>Math.min(a+1,a$))}function a0(){aj(null),al(null),an(J[0]?.code??"EUR"),ap(null),ar("month"),at("0.00"),av(""),ax(!0)}function a1(a,b){return`${String(a).trim().toUpperCase()}|${String(b||"").trim().toLowerCase()||"month"}`}function a2(a){return{...a,currency:String(a.currency).trim().toUpperCase(),interval:String(a.interval||"").trim().toLowerCase()||"month",billing_interval_id:"number"==typeof a.billing_interval_id&&Number.isFinite(a.billing_interval_id)?a.billing_interval_id:null,amount_cents:Number.isFinite(a.amount_cents)?Math.max(0,Math.trunc(a.amount_cents)):0,trial_days:"number"==typeof a.trial_days&&Number.isFinite(a.trial_days)?Math.max(0,Math.trunc(a.trial_days)):null,is_default:!!a.is_default}}async function a3(){if(!V||R)return null;let a=Y.trim();if(!a)return X("Name is required."),w(0),null;if(!aZ.ok)return C(aZ.message??"Invalid prices."),w(1),null;S(!0),U(null),C(null);try{let b=(await (0,p.createBillingPlan)({name:a,code:$.trim()||void 0,description:aa.trim()||void 0,isActive:ac})).plan,c=(Array.isArray(b.versions)?b.versions:[]).filter(a=>"draft"===String(a.status).toLowerCase()).slice().sort((a,b)=>(b.version??0)-(a.version??0))[0]??null;if(!c)throw Error("Plan created but no draft version was returned.");O(b),Q(c);let d=c;for(let a of function(a){let b=a.slice(),c={};for(let a of b){if(!a.is_default)continue;let b=`${a.currency}|${a.interval}`;c[b]=(c[b]??0)+1,c[b]>1&&(a.is_default=!1)}return b}(L.map(a2))){let b=await (0,p.createBillingPrice)({versionId:d.id,currency:a.currency,interval:a.interval,billingIntervalId:a.billing_interval_id,amountCents:a.amount_cents,trialDays:a.trial_days,isDefault:a.is_default});d=b.version,Q(b.version)}let e=[];for(let a of aY){if(!aC[a.id])continue;let b=String(a.value_type??"json");if("boolean"===b){e.push({entitlement_definition_id:a.id,value_json:!0});continue}if("boolean"!==b&&"integer"!==b){let b=aG[a.id]??"",c=""===b.trim()?{}:JSON.parse(b);e.push({entitlement_definition_id:a.id,value_json:c});continue}let c=aE[a.id],d="number"==typeof c&&Number.isFinite(c)?Math.trunc(c):0;e.push({entitlement_definition_id:a.id,value_json:d})}let f=await (0,p.syncBillingPlanVersionEntitlements)({versionId:d.id,entitlements:e});Q(f.version),aN(null),E(a=>a+1);try{window.localStorage.removeItem(r)}catch{}return f.version}catch(a){return U(a instanceof Error?a.message:"Failed to create plan."),null}finally{S(!1)}}async function a4(){if(V&&!ag){ah(!0),aj(null),C(null);try{var a;let b,c,d,e=am.trim().toUpperCase();if(3!==e.length)return void aj("Currency is required.");if(aV.size>0&&!aV.has(e))return void aj("Currency must be one of the allowed currencies.");let f="number"==typeof ao&&Number.isFinite(ao)?ao:null,g=String(aq||"").trim().toLowerCase();if(!f&&!g)return void aj("Interval is required.");let h=(b=Number.parseFloat(as.trim().replace(",",".")),!Number.isFinite(b)||b<0?0:Math.round(100*b)),i=""===au.trim()?null:Number(au),j="number"==typeof i&&Number.isFinite(i)?Math.max(0,Math.trunc(i)):null,k=(a={currency:e,interval:g||"month",ignoreKey:ak},c=a1(a.currency,a.interval),d=(Array.isArray(L)?L:[]).map(a2).filter(b=>!a.ignoreKey||b.key!==a.ignoreKey).filter(a=>a1(a.currency,a.interval)===c),0===d.length||!d.some(a=>!!a.is_default)),l={key:ak??`${Date.now()}_${Math.random().toString(16).slice(2)}`,currency:e,interval:g||"month",billing_interval_id:f,amount_cents:h,trial_days:j,is_default:!!(aw||k)};M(a=>{let b=a2(l),c=a.some(a=>a.key===b.key)?a.map(a=>a.key===b.key?b:a):[...a,b];return b.is_default?c.map(a=>a.key===b.key?a:`${a.currency}|${a.interval}`==`${b.currency}|${b.interval}`?{...a,is_default:!1}:a):c}),af(!1)}catch(a){aj(a instanceof Error?a.message:"Failed to save price.")}finally{ah(!1)}}}async function a5(){if(!V)return!0;if(ay)return!1;az(!0),C(null),aB(null);try{if(!P)return aB("Saved locally. These entitlements will be applied when you create the plan."),!0;let a=[];for(let b of aY){if(!aC[b.id])continue;let c=String(b.value_type??"json");if("boolean"===c){a.push({entitlement_definition_id:b.id,value_json:!0});continue}if("boolean"!==c&&"integer"!==c){let c=aG[b.id]??"";try{let d=""===c.trim()?{}:JSON.parse(c);a.push({entitlement_definition_id:b.id,value_json:d}),aJ(a=>({...a,[b.id]:null}))}catch{return aJ(a=>({...a,[b.id]:"Invalid JSON."})),!1}continue}let d=aE[b.id],e="number"==typeof d&&Number.isFinite(d)?Math.trunc(d):0;a.push({entitlement_definition_id:b.id,value_json:e})}let b=await (0,p.syncBillingPlanVersionEntitlements)({versionId:P.id,entitlements:a});return Q(b.version),aB("Entitlements saved."),aN(null),!0}catch(a){return C(a instanceof Error?a.message:"Failed to save entitlements."),!1}finally{az(!1)}}async function a6(a){let b=a??P;if(!b)return null;aL(!0),aN(null),C(null);try{let a=await (0,p.validateBillingPlanVersionDraft)({versionId:b.id}),c="status"in a&&"ok"===a.status,d="errors"in a&&Array.isArray(a.errors)?a.errors.map(String):[],e={ok:c,errors:d};return aN(e),e}catch(a){return C(a instanceof Error?a.message:"Failed to validate."),null}finally{aL(!1)}}async function a7(){if(!V||R||aK)return;let a=P;a||(a=await a3()),a&&await a6(a)}async function a8(){if(P&&V&&!aQ){aR(!0),C(null);try{let a=await (0,p.activateBillingPlanVersion)({versionId:P.id,confirm:aS.trim()});Q(a.version),aP(!1),aT(""),E(a=>a+1),aN(null)}catch(a){C(a instanceof Error?a.message:"Failed to activate.")}finally{aR(!1)}}}(0,c.useEffect)(()=>{w(a=>Math.min(a,a$))},[a$]),(0,c.useEffect)(()=>{if(!N)try{let a={v:1,step:v,plan:{name:Y,code:$,description:aa,active:!!ac},prices:Array.isArray(L)?L:[],entitlements:{enabled:aC,value:aE,jsonText:aG}};window.localStorage.setItem(r,JSON.stringify(a))}catch{}},[N,aC,aG,aE,ac,$,aa,Y,L,v]);let a9=!!(P&&"active"===String(P.status).toLowerCase()),ba=!!(R||aK);return(0,b.jsx)(e.RequireAuth,{requiredPermission:"admin.billing.read",children:(0,b.jsxs)("div",{className:"space-y-6",children:[z?(0,b.jsx)(g.Alert,{variant:"danger",title:"Could not load billing catalog",children:z}):null,B?(0,b.jsx)(g.Alert,{variant:"danger",title:"Action failed",children:B}):null,(0,b.jsxs)("div",{className:"grid gap-6 lg:grid-cols-[260px_1fr]",children:[(0,b.jsx)(t,{steps:aU,step:v,maxStepAllowed:a$,onStepChange:w}),(0,b.jsxs)("div",{className:"space-y-6",children:[0===v?(0,b.jsxs)(j.Card,{children:[(0,b.jsx)(j.CardHeader,{children:(0,b.jsx)(j.CardTitle,{children:"Plan details"})}),(0,b.jsxs)(j.CardContent,{className:"space-y-4",children:[(0,b.jsx)("div",{className:"rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-[var(--rb-surface-muted)] p-3 text-sm text-zinc-700",children:"Configure the plan here and click Next. The plan will be created on the Review step."}),W?(0,b.jsx)(g.Alert,{variant:"danger",title:"Cannot save plan",children:W}):null,(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("label",{className:"text-sm font-medium",children:"Name"}),(0,b.jsx)(m.Input,{value:Y,onChange:a=>Z(a.target.value),disabled:x||R})]}),(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("label",{className:"text-sm font-medium",children:"Code"}),(0,b.jsx)(m.Input,{value:$,onChange:a=>_(a.target.value),disabled:x||R}),(0,b.jsx)("div",{className:"text-xs text-zinc-500",children:"Leave blank to auto-generate from name."})]}),(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("label",{className:"text-sm font-medium",children:"Description"}),(0,b.jsx)("textarea",{className:"min-h-[90px] w-full rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white px-3 py-2 text-sm",value:aa,onChange:a=>ab(a.target.value),disabled:x||R})]}),(0,b.jsxs)("label",{className:"flex items-center gap-2 text-sm",children:[(0,b.jsx)("input",{type:"checkbox",checked:ac,onChange:a=>ad(a.target.checked),disabled:x||R}),"Active"]}),(0,b.jsxs)("div",{className:"text-xs text-zinc-500",children:["Need to edit existing plans? Use ",(0,b.jsx)(d.default,{className:"underline",href:"/admin/billing/plans",children:"Billing plans"}),"."]})]})]}):null,1===v?(0,b.jsxs)(j.Card,{children:[(0,b.jsxs)(j.CardHeader,{className:"flex flex-row items-start justify-between gap-4",children:[(0,b.jsxs)("div",{className:"min-w-0",children:[(0,b.jsx)(j.CardTitle,{children:"Prices"}),(0,b.jsx)("div",{className:"mt-1 text-sm text-zinc-600",children:"Configure price points per currency + interval, including defaults."})]}),V?(0,b.jsx)(i.Button,{variant:"secondary",size:"sm",onClick:()=>{a0(),af(!0)},disabled:x||ag,children:"Add price"}):null]}),(0,b.jsxs)(j.CardContent,{children:[aZ.message?(0,b.jsx)(g.Alert,{variant:"warning",title:"Prices",children:aZ.message}):null,(0,b.jsx)(l.DataTable,{title:"Price points",data:L,loading:x,emptyMessage:"No prices configured.",getRowId:a=>a.key,columns:[{id:"pair",header:"Currency / interval",cell:a=>(0,b.jsxs)("div",{className:"text-sm text-zinc-800",children:[String(a.currency).toUpperCase()," / ",String(a.interval).toLowerCase()]}),className:"whitespace-nowrap"},{id:"amount",header:"Amount",cell:a=>(0,b.jsx)("div",{className:"text-sm text-zinc-700",children:s(a.amount_cents??0,a.currency)}),className:"whitespace-nowrap"},{id:"trial",header:"Trial",cell:a=>(0,b.jsx)("div",{className:"text-sm text-zinc-700",children:"number"==typeof a.trial_days?`${a.trial_days} days`:"—"}),className:"whitespace-nowrap"},{id:"default",header:"Default",cell:a=>a.is_default?(0,b.jsx)(h.Badge,{variant:"success",children:"default"}):(0,b.jsx)(h.Badge,{variant:"default",children:"—"}),className:"whitespace-nowrap"},{id:"actions",header:"",cell:a=>V?(0,b.jsxs)("div",{className:"flex items-center justify-end gap-2",children:[(0,b.jsx)(i.Button,{variant:"outline",size:"sm",onClick:()=>{a0(),al(a.key),an(String(a.currency).toUpperCase()),ap("number"==typeof a.billing_interval_id?a.billing_interval_id:null),ar(String(a.interval||"").toLowerCase()||"month"),at(((a.amount_cents??0)/100).toFixed(2)),av("number"==typeof a.trial_days?String(a.trial_days):""),ax(!!a.is_default),af(!0)},disabled:ag,children:"Edit"}),(0,b.jsx)(i.Button,{variant:"outline",size:"sm",onClick:()=>{var b;return b=a.key,void M(a=>a.filter(a=>a.key!==b))},disabled:ag,children:"Delete"})]}):null,className:"whitespace-nowrap"}]})]})]}):null,2===v?(0,b.jsxs)(j.Card,{children:[(0,b.jsx)(j.CardHeader,{children:(0,b.jsx)(j.CardTitle,{children:"Entitlements"})}),(0,b.jsxs)(j.CardContent,{className:"space-y-3",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between gap-3",children:[(0,b.jsx)("div",{className:"text-sm text-zinc-600",children:"Toggle features/limits and configure values per type."}),V?(0,b.jsx)(i.Button,{variant:"secondary",size:"sm",onClick:()=>void a5(),disabled:ay,children:ay?"Saving…":"Save entitlements"}):null]}),aA?(0,b.jsx)(g.Alert,{variant:"success",title:"Entitlements",children:aA}):null,0===aY.length?(0,b.jsx)(g.Alert,{variant:"warning",title:"No entitlements",children:"Create entitlement definitions first."}):null,aY.map(a=>{let c=!!aC[a.id],d=aE[a.id],e=String(a.value_type??"json"),f=aI[a.id]??null;return(0,b.jsxs)("div",{className:`rounded-[var(--rb-radius-sm)] border p-3 ${c?"border-[color:color-mix(in_srgb,var(--rb-blue),white_55%)] bg-white":"border-[var(--rb-border)] bg-[var(--rb-surface-muted)]"}`,children:[(0,b.jsxs)("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between",children:[(0,b.jsxs)("div",{className:"min-w-0",children:[(0,b.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[(0,b.jsx)("div",{className:"text-sm font-semibold text-zinc-900",children:a.name}),(0,b.jsx)(h.Badge,{variant:c?"success":"default",children:c?"Enabled":"Disabled"}),(0,b.jsx)(h.Badge,{variant:"info",children:e}),a.is_premium?(0,b.jsx)(h.Badge,{variant:"warning",children:"premium"}):null]}),(0,b.jsx)("div",{className:"mt-1 text-xs text-zinc-500 font-mono",children:a.code}),a.description?(0,b.jsx)("div",{className:"mt-2 text-sm text-zinc-600",children:a.description}):null]}),(0,b.jsx)("div",{className:"flex items-center justify-between gap-3 sm:flex-col sm:items-end",children:(0,b.jsxs)("label",{className:"flex items-center gap-2 text-sm font-medium",children:[(0,b.jsx)("input",{type:"checkbox",checked:c,disabled:!V,onChange:b=>{let c=b.target.checked;aD(b=>({...b,[a.id]:c})),c&&"boolean"===e&&aF(b=>({...b,[a.id]:!0}))}}),"Enable"]})})]}),c?(0,b.jsx)("div",{className:"mt-3 rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white p-3",children:"boolean"===e?(0,b.jsx)("div",{className:"text-sm text-zinc-700",children:"Feature enabled."}):"integer"===e?(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("label",{className:"text-sm font-medium",children:"Limit"}),(0,b.jsx)(m.Input,{type:"number",value:null==d?"":String(d),disabled:!V,onChange:b=>{let c=b.target.value;if(""===c.trim())return void aF(b=>({...b,[a.id]:null}));let d=Number(c);Number.isFinite(d)&&aF(b=>({...b,[a.id]:Math.trunc(d)}))}}),(0,b.jsx)("div",{className:"text-xs text-zinc-500",children:"Use a whole number (e.g. 10, 100, 1000)."})]}):(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("label",{className:"text-sm font-medium",children:"Value (JSON)"}),(0,b.jsx)("textarea",{className:"min-h-[110px] w-full rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white px-3 py-2 font-mono text-sm",value:aG[a.id]??"",disabled:!V,onChange:b=>{aH(c=>({...c,[a.id]:b.target.value})),aJ(b=>({...b,[a.id]:null}))}}),f?(0,b.jsx)("div",{className:"text-xs text-red-600",children:f}):null]})}):null]},a.id)})]})]}):null,3===v?(0,b.jsxs)(j.Card,{children:[(0,b.jsxs)(j.CardHeader,{className:"flex flex-row items-start justify-between gap-4",children:[(0,b.jsxs)("div",{className:"min-w-0",children:[(0,b.jsx)(j.CardTitle,{children:"Review"}),(0,b.jsx)("div",{className:"mt-1 text-sm text-zinc-600",children:"Create the plan from your configuration, then validate/activate the draft."})]}),(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)(d.default,{href:"/admin/billing/plans",children:(0,b.jsx)(i.Button,{variant:"outline",size:"sm",children:"Back to plans"})}),(0,b.jsx)(i.Button,{variant:"secondary",size:"sm",onClick:()=>aP(!0),disabled:!V||aQ||a9||!aM?.ok,children:a9?"Activated":"Activate"})]})]}),(0,b.jsxs)(j.CardContent,{className:"space-y-4",children:[T?(0,b.jsx)(g.Alert,{variant:"danger",title:"Create failed",children:T}):null,(0,b.jsxs)("div",{className:"rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white p-3",children:[(0,b.jsx)("div",{className:"text-sm font-semibold text-zinc-900",children:"Next actions"}),(0,b.jsxs)("div",{className:"mt-2 space-y-2",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between gap-3",children:[(0,b.jsx)("div",{className:"text-sm text-zinc-700",children:"1. Save & validate"}),a9||aM?.ok?(0,b.jsx)(h.Badge,{variant:"success",children:"done"}):ba?(0,b.jsx)(h.Badge,{variant:"info",children:"running"}):(0,b.jsx)(h.Badge,{variant:"default",children:"pending"})]}),(0,b.jsxs)("div",{className:"flex items-center justify-between gap-3",children:[(0,b.jsx)("div",{className:"text-sm text-zinc-700",children:"2. Activate"}),a9?(0,b.jsx)(h.Badge,{variant:"success",children:"active"}):aM?.ok?(0,b.jsx)(h.Badge,{variant:"default",children:"ready"}):(0,b.jsx)(h.Badge,{variant:"default",children:"locked"})]})]})]}),N&&P?(0,b.jsxs)(g.Alert,{variant:"success",title:"Plan created",children:["Plan ",(0,b.jsx)("span",{className:"font-mono",children:N.code})," created. Draft version id ",P.id,"."]}):(0,b.jsx)(g.Alert,{variant:"info",title:"Not saved yet",children:"Click Save & validate to persist this configuration."}),a9?(0,b.jsx)(g.Alert,{variant:"success",title:"Activated",children:"This plan version is active."}):aM?aM.ok?(0,b.jsx)(g.Alert,{variant:"success",title:"Validation passed",children:"This draft version is ready to activate."}):(0,b.jsx)(g.Alert,{variant:"warning",title:"Validation failed",children:(0,b.jsx)("div",{className:"space-y-1",children:aM.errors.map((a,c)=>(0,b.jsx)("div",{children:a},c))})}):(0,b.jsx)(g.Alert,{variant:"info",title:"Not validated",children:"Click Save & validate to run server-side checks."}),(0,b.jsxs)("div",{className:"grid grid-cols-1 gap-4 lg:grid-cols-3",children:[(0,b.jsxs)(j.Card,{className:"lg:col-span-1",children:[(0,b.jsx)(j.CardHeader,{children:(0,b.jsx)(j.CardTitle,{children:"Plan"})}),(0,b.jsxs)(j.CardContent,{className:"space-y-3",children:[(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("div",{className:"text-xs font-medium uppercase tracking-wide text-zinc-500",children:"Name"}),(0,b.jsx)("div",{className:"text-sm font-semibold text-zinc-900",children:Y.trim()||"—"})]}),(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("div",{className:"text-xs font-medium uppercase tracking-wide text-zinc-500",children:"Code"}),(0,b.jsx)("div",{className:"text-sm text-zinc-700",children:$.trim()?(0,b.jsx)("span",{className:"font-mono",children:$.trim()}):(0,b.jsx)("span",{className:"text-zinc-500",children:"auto-generated"})})]}),(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("div",{className:"text-xs font-medium uppercase tracking-wide text-zinc-500",children:"Status"}),(0,b.jsx)("div",{children:ac?(0,b.jsx)(h.Badge,{variant:"success",children:"active"}):(0,b.jsx)(h.Badge,{variant:"default",children:"inactive"})})]}),(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("div",{className:"text-xs font-medium uppercase tracking-wide text-zinc-500",children:"Description"}),(0,b.jsx)("div",{className:"text-sm text-zinc-700 whitespace-pre-wrap",children:aa.trim()||"—"})]})]})]}),(0,b.jsxs)(j.Card,{className:"lg:col-span-2",children:[(0,b.jsx)(j.CardHeader,{children:(0,b.jsx)(j.CardTitle,{children:"Prices"})}),(0,b.jsx)(j.CardContent,{children:(0,b.jsx)(l.DataTable,{title:"Price points",data:(Array.isArray(L)?L:[]).slice().map(a=>a2(a)).sort((a,b)=>`${a.currency}|${a.interval}`.localeCompare(`${b.currency}|${b.interval}`)),loading:!1,emptyMessage:"No prices configured.",getRowId:a=>a.key,columns:[{id:"currency",header:"Currency",cell:a=>{let c=String(a.currency).toUpperCase(),d=J.find(a=>a.code===c)??null;return(0,b.jsxs)("div",{className:"space-y-0.5",children:[(0,b.jsx)("div",{className:"text-sm font-medium text-zinc-900",children:c}),d?.name?(0,b.jsx)("div",{className:"text-xs text-zinc-500",children:d.name}):null]})},className:"whitespace-nowrap"},{id:"interval",header:"Interval",cell:a=>(0,b.jsx)("div",{className:"text-sm text-zinc-700",children:String(a.interval).toLowerCase()}),className:"whitespace-nowrap"},{id:"amount",header:"Amount",cell:a=>(0,b.jsx)("div",{className:"text-sm text-zinc-800",children:s(a.amount_cents??0,a.currency)}),className:"whitespace-nowrap"},{id:"trial",header:"Trial",cell:a=>(0,b.jsx)("div",{className:"text-sm text-zinc-700",children:"number"==typeof a.trial_days?`${a.trial_days} days`:"—"}),className:"whitespace-nowrap"},{id:"default",header:"Default",cell:a=>a.is_default?(0,b.jsx)(h.Badge,{variant:"success",children:"default"}):(0,b.jsx)(h.Badge,{variant:"default",children:"—"}),className:"whitespace-nowrap"}]})})]})]}),(0,b.jsxs)(j.Card,{children:[(0,b.jsx)(j.CardHeader,{children:(0,b.jsx)(j.CardTitle,{children:"Entitlements"})}),(0,b.jsx)(j.CardContent,{children:0===aY.filter(a=>!!aC[a.id]).length?(0,b.jsx)("div",{className:"text-sm text-zinc-600",children:"No entitlements enabled."}):(0,b.jsx)("div",{className:"space-y-2",children:aY.filter(a=>!!aC[a.id]).map(a=>{let c=String(a.value_type??"json"),d=aE[a.id],e="—";return e="boolean"===c?d?"Enabled":"Disabled":"integer"===c?"number"==typeof d?String(d):null===d?"—":String(d):(aG[a.id]??"").trim()?"Custom":"—",(0,b.jsxs)("div",{className:"flex flex-col gap-2 rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white p-3 sm:flex-row sm:items-center sm:justify-between",children:[(0,b.jsxs)("div",{className:"min-w-0",children:[(0,b.jsxs)("div",{className:"text-sm font-semibold text-zinc-900",children:[a.name," ",(0,b.jsxs)("span",{className:"text-xs font-normal text-zinc-500",children:["(",a.code,")"]})]}),(0,b.jsxs)("div",{className:"mt-0.5 text-xs text-zinc-500",children:["Type: ",c]})]}),(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[a.is_premium?(0,b.jsx)(h.Badge,{variant:"warning",children:"premium"}):null,(0,b.jsx)(h.Badge,{variant:"info",children:e})]})]},a.id)})})})]})]})]}):null,(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsx)(i.Button,{variant:"outline",onClick:function(){w(a=>Math.max(a-1,0))},disabled:0===v,children:"Back"}),(0,b.jsxs)("div",{className:"flex items-center justify-between gap-4",children:[(0,b.jsxs)("div",{className:"text-sm text-zinc-500",children:["Step ",v+1," of ",aU.length]}),(0,b.jsx)(i.Button,{variant:"primary",onClick:()=>{if(v!==aU.length-1)return void a_();if(V&&!a9){if(!aM?.ok)return void a7();aP(!0)}},disabled:v>a$||2===v&&ay||v===aU.length-1&&(!V||aQ||a9||!aM?.ok&&ba),children:v===aU.length-1?a9?"Activated":aM?.ok?aQ?"Activating…":"Activate":ba?"Saving & validating…":"Save & validate":"Next"})]})]})]})]}),(0,b.jsx)(n.Modal,{open:ae,onClose:()=>{ag||af(!1)},title:ak?"Edit price":"Add price",footer:(0,b.jsxs)("div",{className:"flex items-center justify-end gap-2",children:[(0,b.jsx)(i.Button,{variant:"outline",onClick:()=>ag?null:af(!1),disabled:ag,children:"Cancel"}),(0,b.jsx)(i.Button,{variant:"primary",onClick:()=>void a4(),disabled:ag,children:ag?"Saving…":"Save"})]}),children:(0,b.jsxs)("div",{className:"space-y-4",children:[ai?(0,b.jsx)(g.Alert,{variant:"danger",title:"Cannot save price",children:ai}):null,(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("label",{className:"text-sm font-medium",children:"Currency"}),(0,b.jsxs)("select",{className:"w-full rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white px-3 py-2 text-sm",value:am,onChange:a=>an(a.target.value),disabled:ag||!!ak||0===J.length,children:[0===J.length?(0,b.jsx)("option",{value:am,children:am}):null,J.map(a=>(0,b.jsxs)("option",{value:a.code,children:[a.code,a.name?` — ${a.name}`:""]},a.code))]}),0===J.length?(0,b.jsx)("div",{className:"text-xs text-zinc-500",children:"No allowed currencies found. Add currencies under Admin / Billing / Currencies."}):null]}),(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("label",{className:"text-sm font-medium",children:"Interval"}),H.length>0?(0,b.jsxs)("select",{className:"w-full rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white px-3 py-2 text-sm",value:ao??"",onChange:a=>{let b=a.target.value,c=b?Number(b):null,d=H.find(a=>a.id===c)??null;ap(d?d.id:null),ar(d?String(d.code).toLowerCase():"")},disabled:ag||!!ak,children:[(0,b.jsx)("option",{value:"",children:"Select interval"}),H.slice().sort((a,b)=>(a.months??0)-(b.months??0)||String(a.name).localeCompare(String(b.name))).map(a=>(0,b.jsxs)("option",{value:a.id,children:[a.name," (",a.months," months)"]},a.id))]}):(0,b.jsxs)("select",{className:"w-full rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white px-3 py-2 text-sm",value:aq,onChange:a=>ar("year"===a.target.value?"year":"month"),disabled:ag||!!ak,children:[(0,b.jsx)("option",{value:"month",children:"month"}),(0,b.jsx)("option",{value:"year",children:"year"})]}),ak?(0,b.jsx)("div",{className:"text-xs text-zinc-500",children:"Currency and interval are immutable for an existing price."}):null]}),(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("label",{className:"text-sm font-medium",children:"Amount"}),(0,b.jsx)(m.Input,{value:as,onChange:a=>at(a.target.value),disabled:ag})]}),(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("label",{className:"text-sm font-medium",children:"Trial days (optional)"}),(0,b.jsx)(m.Input,{value:au,onChange:a=>av(a.target.value),disabled:ag})]}),(0,b.jsxs)("label",{className:"flex items-center gap-2 text-sm",children:[(0,b.jsx)("input",{type:"checkbox",checked:aw,onChange:a=>ax(a.target.checked),disabled:ag}),"Default for this currency + interval"]})]})}),(0,b.jsx)(k.ConfirmDialog,{open:aO,title:"Activate",message:(0,b.jsxs)("div",{className:"space-y-3",children:[(0,b.jsx)("div",{children:"This will activate the selected draft version and automatically retire the current active version (if any)."}),(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("label",{className:"text-sm font-medium",children:"Type ACTIVATE to confirm"}),(0,b.jsx)(m.Input,{value:aS,onChange:a=>aT(a.target.value)})]})]}),confirmText:"Activate",confirmVariant:"secondary",busy:aQ,onCancel:()=>aP(!1),onConfirm:()=>{a8()}})]})})}a.s(["default",()=>u])}];

//# sourceMappingURL=frontend_src_app_admin_billing_builder_page_tsx_683dd5e1._.js.map