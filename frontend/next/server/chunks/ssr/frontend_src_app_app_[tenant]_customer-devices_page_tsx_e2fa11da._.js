module.exports=[19766,a=>{"use strict";var b=a.i(57850),c=a.i(45056),d=a.i(93609),e=a.i(91601),f=a.i(75458),g=a.i(97867),h=a.i(17933),i=a.i(75385),j=a.i(4600),k=a.i(21282),l=a.i(54177),m=a.i(46036),n=a.i(94703),o=a.i(54804),p=a.i(34075);function q(){let a=(0,f.useAuth)(),q=(0,d.useRouter)(),r=(0,d.useParams)(),s=r.business??r.tenant,[t,u]=c.default.useState(!0),[v,w]=c.default.useState(null),[x,y]=c.default.useState(null),[z,A]=c.default.useState(!1),[B,C]=c.default.useState([]),[D,E]=c.default.useState([]),[F,G]=c.default.useState([]),[H,I]=c.default.useState([]),[J,K]=c.default.useState([]),[L,M]=c.default.useState(""),[N,O]=c.default.useState(0),[P,Q]=c.default.useState(10),[R,S]=c.default.useState(!1),[T,U]=c.default.useState(null),[V,W]=c.default.useState(null),[X,Y]=c.default.useState(null),[Z,$]=c.default.useState(""),[_,aa]=c.default.useState(""),[ab,ac]=c.default.useState(""),[ad,ae]=c.default.useState(""),[af,ag]=c.default.useState(!1),[ah,ai]=c.default.useState(""),[aj,ak]=c.default.useState(""),[al,am]=c.default.useState(null),[an,ao]=c.default.useState(!1),[ap,aq]=c.default.useState(!1),[ar,as]=c.default.useState(null),[at,au]=c.default.useState(null),[av,aw]=c.default.useState(null),[ax,ay]=c.default.useState([]),az=a.can("customer_devices.manage"),aA=c.default.useCallback(async()=>{try{if(u(!0),w(null),"string"!=typeof s||0===s.length)throw Error("Business is missing.");let[a,b,c,d,e]=await Promise.all([(0,p.apiFetch)(`/api/${s}/app/repairbuddy/customer-devices?limit=200`),(0,p.apiFetch)(`/api/${s}/app/clients?limit=200`),(0,p.apiFetch)(`/api/${s}/app/repairbuddy/devices?limit=200`),(0,p.apiFetch)(`/api/${s}/app/repairbuddy/device-brands?limit=200`),(0,p.apiFetch)(`/api/${s}/app/repairbuddy/device-types?limit=200`)]);C(Array.isArray(a?.customer_devices)?a.customer_devices:[]),E(Array.isArray(b?.clients)?b.clients:[]),G(Array.isArray(c?.devices)?c.devices:[]),I(Array.isArray(d?.device_brands)?d.device_brands:[]),K(Array.isArray(e?.device_types)?e.device_types:[])}catch(a){if(a instanceof p.ApiError&&428===a.status&&"string"==typeof s&&s.length>0){let a=`/app/${s}/customer-devices`;q.replace(`/app/${s}/branches/select?next=${encodeURIComponent(a)}`);return}w(a instanceof Error?a.message:"Failed to load customer devices.")}finally{u(!1)}},[q,s]);async function aB(a){if((a.preventDefault(),!z)&&"string"==typeof s&&0!==s.length){if(!az)return void w("Forbidden.");A(!0),w(null),y(null);try{if("number"!=typeof V)return void w("Client is required.");let a=Z.trim();if(0===a.length)return void w("Label is required.");let b={customer_id:V,device_id:X,label:a,serial:_.trim().length>0?_.trim():null,pin:ab.trim().length>0?ab.trim():null,notes:ad.trim().length>0?ad.trim():null};T?(await (0,p.apiFetch)(`/api/${s}/app/repairbuddy/customer-devices/${T}`,{method:"PATCH",body:b}),y("Customer device updated.")):(await (0,p.apiFetch)(`/api/${s}/app/repairbuddy/customer-devices`,{method:"POST",body:b}),y("Customer device created.")),S(!1),O(0),await aA()}catch(a){a instanceof p.ApiError?w(a.message):w(T?"Failed to update customer device.":"Failed to create customer device.")}finally{A(!1)}}}async function aC(a){var c;if(z||"string"!=typeof s||0===s.length)return;if(!az)return void w("Forbidden.");let d=a.device?`${a.brand?.name??""} ${a.device.model}`.trim():a.customerDevice.label;c={title:"Delete customer device",message:(0,b.jsxs)("div",{children:["Delete ",(0,b.jsx)("span",{className:"font-semibold",children:d}),"?"]}),action:async()=>{A(!0),w(null),y(null);try{await (0,p.apiFetch)(`/api/${s}/app/repairbuddy/customer-devices/${a.customerDevice.id}`,{method:"DELETE"}),y("Customer device deleted."),O(0),await aA()}catch(a){a instanceof p.ApiError?w(a.message):w("Failed to delete customer device.")}finally{A(!1)}}},ai(c.title),ak(c.message),am(()=>c.action),ag(!0)}async function aD(a){if(as(null),au(null),"string"!=typeof s||0===s.length)return void as("Business is missing.");aw(a),ao(!0),aq(!0);try{let b=await (0,p.apiFetch)(`/api/${s}/app/repairbuddy/customer-devices/${a.customerDevice.id}/extra-fields`);ay(Array.isArray(b?.extra_fields)?b.extra_fields:[])}catch(a){if(a instanceof p.ApiError&&428===a.status&&"string"==typeof s&&s.length>0){let a=`/app/${s}/customer-devices`;q.replace(`/app/${s}/branches/select?next=${encodeURIComponent(a)}`);return}as(a instanceof Error?a.message:"Failed to load extra fields."),ay([])}finally{aq(!1)}}async function aE(){if(as(null),au(null),!av)return void as("No customer device selected.");if("string"!=typeof s||0===s.length)return void as("Business is missing.");aq(!0);try{let a=await (0,p.apiFetch)(`/api/${s}/app/repairbuddy/customer-devices/${av.customerDevice.id}/extra-fields`,{method:"PUT",body:{values:ax.map(a=>({field_definition_id:a.field_definition_id,value_text:a.value_text}))}});ay(Array.isArray(a?.extra_fields)?a.extra_fields:[]),au("Saved.")}catch(a){as(a instanceof Error?a.message:"Failed to save extra fields.")}finally{aq(!1)}}c.default.useEffect(()=>{aA()},[aA]);let aF=c.default.useMemo(()=>new Map(D.map(a=>[a.id,a])),[D]),aG=c.default.useMemo(()=>new Map(F.map(a=>[a.id,a])),[F]),aH=c.default.useMemo(()=>new Map(H.map(a=>[a.id,a])),[H]),aI=c.default.useMemo(()=>new Map(J.map(a=>[a.id,a])),[J]),aJ=c.default.useMemo(()=>B.map(a=>{let b=aF.get(a.customer_id)??null,c="number"==typeof a.device_id?aG.get(a.device_id)??null:null,d=c?aH.get(c.device_brand_id)??null:null,e=c?aI.get(c.device_type_id)??null:null;return{customerDevice:a,client:b,device:c,brand:d,type:e}}),[aH,aF,B,aG,aI]),aK=c.default.useMemo(()=>{let a=L.trim().toLowerCase();return a?aJ.filter(b=>{let c=b.device?`${b.brand?.name??""} ${b.device.model}`.trim():b.customerDevice.label;return`${b.customerDevice.id} ${c} ${b.client?.name??""} ${b.customerDevice.serial??""}`.toLowerCase().includes(a)}):aJ},[L,aJ]),aL=aK.length,aM=c.default.useMemo(()=>{let a=N*P,b=a+P;return aK.slice(a,b)},[aK,N,P]),aN=c.default.useMemo(()=>[{id:"device",header:"Device",cell:a=>(0,b.jsxs)("div",{className:"min-w-0",children:[(0,b.jsx)("div",{className:"truncate font-semibold text-[var(--rb-text)]",children:a.device?`${a.brand?.name??""} ${a.device.model}`.trim():a.customerDevice.label}),(0,b.jsx)("div",{className:"truncate text-xs text-zinc-600",children:a.customerDevice.id})]}),className:"min-w-[280px]"},{id:"client",header:"Client",cell:a=>(0,b.jsx)("div",{className:"text-sm text-zinc-700",children:a.client?.name??a.customerDevice.customer_id}),className:"min-w-[220px]"},{id:"type",header:"Type",cell:a=>(0,b.jsx)("div",{className:"text-sm text-zinc-700",children:a.type?.name??"—"}),className:"min-w-[160px]"},{id:"serial",header:"Serial",cell:a=>(0,b.jsx)(h.Badge,{variant:"default",children:a.customerDevice.serial??"—"}),className:"whitespace-nowrap"},{id:"actions",header:"",headerClassName:"text-right",className:"w-[160px] whitespace-nowrap text-right",cell:a=>az?(0,b.jsx)(m.DropdownMenu,{align:"right",trigger:({toggle:a})=>(0,b.jsx)(g.Button,{variant:"ghost",size:"sm",onClick:a,disabled:z,className:"px-2",children:"Actions"}),children:({close:c})=>(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(m.DropdownMenuItem,{onSelect:()=>{c(),az&&(U(a.customerDevice.id),W(a.customerDevice.customer_id),Y("number"==typeof a.customerDevice.device_id?a.customerDevice.device_id:null),$(a.customerDevice.label??""),aa(a.customerDevice.serial??""),ac(a.customerDevice.pin??""),ae(a.customerDevice.notes??""),S(!0),w(null),y(null))},disabled:z,children:"Edit"}),(0,b.jsx)(m.DropdownMenuItem,{onSelect:()=>{c(),aD(a)},disabled:z,children:"Extra fields"}),(0,b.jsx)(m.DropdownMenuSeparator,{}),(0,b.jsx)(m.DropdownMenuItem,{destructive:!0,onSelect:()=>{c(),aC(a)},disabled:z,children:"Delete"})]})}):(0,b.jsx)("div",{className:"flex justify-end",children:(0,b.jsx)(g.Button,{variant:"outline",size:"sm",onClick:()=>void aD(a),children:"Extra fields"})})}],[z,az,s]);return(0,b.jsx)(e.RequireAuth,{requiredPermission:"customer_devices.view",children:(0,b.jsxs)("div",{className:"space-y-4",children:[(0,b.jsx)(k.ConfirmDialog,{open:af,title:ah,message:aj,busy:z,confirmText:"Delete",confirmVariant:"secondary",onCancel:()=>{z||(ag(!1),am(null))},onConfirm:()=>{al&&(async()=>{await al(),ag(!1),am(null)})()}}),(0,b.jsx)(n.Modal,{open:R,onClose:()=>{z||S(!1)},title:T?"Edit customer device":"Add customer device",footer:(0,b.jsxs)("div",{className:"flex items-center justify-end gap-2",children:[(0,b.jsx)(g.Button,{variant:"outline",onClick:()=>S(!1),disabled:z,children:"Cancel"}),(0,b.jsx)(g.Button,{disabled:z,type:"submit",form:"rb_customer_device_form",children:z?"Saving...":"Save"})]}),children:(0,b.jsxs)("form",{id:"rb_customer_device_form",className:"space-y-3",onSubmit:aB,children:[(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("label",{className:"text-sm font-medium",htmlFor:"cd_customer",children:"Client"}),(0,b.jsx)("select",{id:"cd_customer",className:"w-full rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white px-3 py-2 text-sm",value:V??"",onChange:a=>{let b=a.target.value;if(!b)return void W(null);let c=Number(b);W(Number.isFinite(c)?c:null)},disabled:z,children:D.slice().sort((a,b)=>a.name.localeCompare(b.name)).map(a=>(0,b.jsx)("option",{value:a.id,children:a.name},a.id))})]}),(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("label",{className:"text-sm font-medium",htmlFor:"cd_device",children:"Device model (optional)"}),(0,b.jsxs)("select",{id:"cd_device",className:"w-full rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white px-3 py-2 text-sm",value:X??"",onChange:a=>{let b=a.target.value;if(!b)return void Y(null);let c=Number(b);Y(Number.isFinite(c)?c:null)},disabled:z,children:[(0,b.jsx)("option",{value:"",children:"(none)"}),F.slice().sort((a,b)=>a.model.localeCompare(b.model)).map(a=>(0,b.jsx)("option",{value:a.id,children:a.model},a.id))]})]}),(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("label",{className:"text-sm font-medium",htmlFor:"cd_label",children:"Label"}),(0,b.jsx)("input",{id:"cd_label",className:"w-full rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white px-3 py-2 text-sm",value:Z,onChange:a=>$(a.target.value),disabled:z,required:!0})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 gap-3 sm:grid-cols-2",children:[(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("label",{className:"text-sm font-medium",htmlFor:"cd_serial",children:"Serial"}),(0,b.jsx)("input",{id:"cd_serial",className:"w-full rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white px-3 py-2 text-sm",value:_,onChange:a=>aa(a.target.value),disabled:z})]}),(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("label",{className:"text-sm font-medium",htmlFor:"cd_pin",children:"PIN"}),(0,b.jsx)("input",{id:"cd_pin",className:"w-full rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white px-3 py-2 text-sm",value:ab,onChange:a=>ac(a.target.value),disabled:z})]})]}),(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("label",{className:"text-sm font-medium",htmlFor:"cd_notes",children:"Notes"}),(0,b.jsx)("textarea",{id:"cd_notes",className:"w-full rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white px-3 py-2 text-sm",value:ad,onChange:a=>ae(a.target.value),disabled:z,rows:4})]})]})}),x?(0,b.jsx)("div",{className:"text-sm text-green-700",children:x}):null,v?(0,b.jsx)("div",{className:"text-sm text-red-600",children:v}):null,(0,b.jsxs)(o.ListPageShell,{title:"Customer Devices",description:"Devices owned by clients (intake inventory).",actions:(0,b.jsx)(g.Button,{variant:"primary",size:"sm",onClick:function(){az&&(U(null),W(D.length>0?D[0].id:null),Y(null),$(""),aa(""),ac(""),ae(""),S(!0),w(null),y(null))},disabled:!az||t||z,children:"Add device"}),loading:t,error:null,empty:!t&&!v&&0===aJ.length,emptyTitle:"No customer devices",emptyDescription:"Customer devices will appear when linked to clients.",children:[(0,b.jsxs)(n.Modal,{open:an,onClose:()=>{ap||(ao(!1),aw(null),ay([]),as(null),au(null))},title:av?`Extra Fields \xb7 #${av.customerDevice.id}`:"Extra Fields",footer:(0,b.jsxs)("div",{className:"flex items-center justify-end gap-2",children:[(0,b.jsx)(g.Button,{variant:"outline",onClick:()=>{ap||(ao(!1),aw(null),ay([]),as(null),au(null))},disabled:ap,children:"Close"}),(0,b.jsx)(g.Button,{onClick:()=>void aE(),disabled:ap,children:ap?"Saving...":"Save"})]}),children:[ar?(0,b.jsx)(i.Alert,{variant:"danger",title:"Could not load extra fields",children:ar}):null,at?(0,b.jsx)(i.Alert,{variant:"success",title:"Success",children:at}):null,ap&&0===ax.length?(0,b.jsx)("div",{className:"text-sm text-zinc-500",children:"Loading..."}):null,ap||0!==ax.length?null:(0,b.jsx)("div",{className:"text-sm text-zinc-600",children:"No extra fields defined."}),ax.length>0?(0,b.jsx)("div",{className:"space-y-3",children:ax.filter(a=>a.is_active).map(a=>(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("div",{className:"text-sm font-medium text-[var(--rb-text)]",children:a.label}),(0,b.jsx)("input",{className:"h-10 w-full rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white px-3 text-sm",value:a.value_text??"",onChange:b=>{let c=b.target.value;ay(b=>b.map(b=>b.field_definition_id===a.field_definition_id?{...b,value_text:c}:b))},disabled:ap})]},a.field_definition_id))}):null]}),(0,b.jsx)(j.Card,{className:"shadow-none",children:(0,b.jsx)(j.CardContent,{className:"pt-5",children:(0,b.jsx)(l.DataTable,{title:"string"==typeof s?`Customer Devices \xb7 ${s}`:"Customer Devices",data:aM,loading:t,emptyMessage:"No customer devices.",columns:aN,getRowId:a=>a.customerDevice.id,search:{placeholder:"Search devices, clients, serial..."},server:{query:L,onQueryChange:a=>{M(a),O(0)},pageIndex:N,onPageIndexChange:O,pageSize:P,onPageSizeChange:a=>{Q(a),O(0)},totalRows:aL}})})})]})]})})}a.s(["default",()=>q])}];

//# sourceMappingURL=frontend_src_app_app_%5Btenant%5D_customer-devices_page_tsx_e2fa11da._.js.map