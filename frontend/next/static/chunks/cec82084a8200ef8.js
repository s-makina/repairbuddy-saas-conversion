(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,22648,e=>{"use strict";var t=e.i(48277),i=e.i(30668),a=e.i(16506),n=e.i(77252),s=e.i(24273),l=e.i(63571),r=e.i(68501),d=e.i(9693),c=e.i(72015),o=e.i(64998),u=e.i(37574),m=e.i(26550),x=e.i(66474),h=e.i(1831),v=e.i(21190),f=e.i(1314);let p="admin.billing.builder.draft.v1";function b(e,t){let i=Number.isFinite(e)?e:0,a=(t||"").toUpperCase()||"XXX";return`${(i/100).toFixed(2)} ${a}`}function g({steps:e,step:i,maxStepAllowed:a,onStepChange:n}){let s=Math.max(0,Math.min(i,e.length-1)),l=Math.max(1,e.length-1);return(0,t.jsxs)(c.Card,{className:"shadow-none lg:sticky lg:top-6 lg:self-start",children:[(0,t.jsx)(c.CardHeader,{className:"pb-3",children:(0,t.jsxs)("div",{className:"flex items-start justify-between gap-4",children:[(0,t.jsxs)("div",{className:"min-w-0",children:[(0,t.jsx)(c.CardTitle,{className:"text-base",children:"Builder steps"}),(0,t.jsx)(c.CardDescription,{children:"Follow the steps to build and create a plan."})]}),(0,t.jsxs)("div",{className:"text-right",children:[(0,t.jsxs)("div",{className:"text-xs text-zinc-500",children:["Step ",s+1," of ",e.length]}),(0,t.jsx)("div",{className:"mt-2",children:(0,t.jsx)(r.Badge,{variant:s===e.length-1?"info":"default",children:e[s]??""})})]})]})}),(0,t.jsxs)(c.CardContent,{className:"space-y-4",children:[(0,t.jsx)("div",{className:"h-2 w-full overflow-hidden rounded-full bg-[var(--rb-border)]",children:(0,t.jsx)("div",{className:"h-full bg-[linear-gradient(90deg,var(--rb-blue),var(--rb-orange))]",style:{width:`${Math.round(s/l*100)}%`}})}),(0,t.jsx)("nav",{"aria-label":"Builder steps",className:"space-y-1",children:e.map((e,i)=>{let l=i===s,r=i<s,d=i<=a;return(0,t.jsx)("button",{type:"button",disabled:!d,onClick:()=>{d&&n(i)},className:"w-full rounded-[var(--rb-radius-md)] border px-3 py-2 text-left transition disabled:cursor-not-allowed disabled:opacity-60 "+(l?"border-[color:color-mix(in_srgb,var(--rb-blue),white_65%)] bg-[color:color-mix(in_srgb,var(--rb-blue),white_92%)]":r?"border-[color:color-mix(in_srgb,var(--rb-blue),white_75%)] bg-white hover:bg-[var(--rb-surface-muted)]":"border-[var(--rb-border)] bg-white hover:bg-[var(--rb-surface-muted)]"),children:(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("div",{className:"flex h-7 w-7 shrink-0 items-center justify-center rounded-full border text-xs font-semibold "+(l?"border-[var(--rb-blue)] bg-[var(--rb-blue)] text-white":r?"border-[var(--rb-blue)] bg-[color:color-mix(in_srgb,var(--rb-blue),white_90%)] text-[var(--rb-blue)]":"border-[var(--rb-border)] bg-white text-zinc-600"),children:r?(0,t.jsx)("svg",{viewBox:"0 0 24 24",className:"h-4 w-4",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":"true",children:(0,t.jsx)("path",{d:"M20 6L9 17l-5-5"})}):i+1}),(0,t.jsxs)("div",{className:"min-w-0",children:[(0,t.jsx)("div",{className:"text-sm font-semibold text-[var(--rb-text)]",children:e}),(0,t.jsx)("div",{className:"mt-0.5 text-xs text-zinc-600",children:0===i?"Plan details.":1===i?"Price points.":2===i?"Entitlements.":"Create & activate."})]})]})},e)})})]})]})}function j(){let e=(0,s.useDashboardHeader)(),j=(0,f.useAuth)(),[y,N]=(0,i.useState)(0),[w,C]=(0,i.useState)(!0),[_,S]=(0,i.useState)(null),[k,A]=(0,i.useState)(null),[z,B]=(0,i.useState)(0),[M,T]=(0,i.useState)([]),[E,I]=(0,i.useState)([]),[F,$]=(0,i.useState)([]),[P,D]=(0,i.useState)([]),[L,U]=(0,i.useState)(null),[H,O]=(0,i.useState)(null),[R,V]=(0,i.useState)(!1),[J,q]=(0,i.useState)(null),K=j.can("admin.billing.write"),[X,W]=(0,i.useState)(null),[G,Q]=(0,i.useState)(""),[Y,Z]=(0,i.useState)(""),[ee,et]=(0,i.useState)(""),[ei,ea]=(0,i.useState)(!0),[en,es]=(0,i.useState)(!1),[el,er]=(0,i.useState)(!1),[ed,ec]=(0,i.useState)(null),[eo,eu]=(0,i.useState)(null),[em,ex]=(0,i.useState)("EUR"),[eh,ev]=(0,i.useState)(null),[ef,ep]=(0,i.useState)("month"),[eb,eg]=(0,i.useState)("0.00"),[ej,ey]=(0,i.useState)(""),[eN,ew]=(0,i.useState)(!1),[eC,e_]=(0,i.useState)(!1),[eS,ek]=(0,i.useState)(null),[eA,ez]=(0,i.useState)({}),[eB,eM]=(0,i.useState)({}),[eT,eE]=(0,i.useState)({}),[eI,eF]=(0,i.useState)({}),[e$,eP]=(0,i.useState)(!1),[eD,eL]=(0,i.useState)(null),[eU,eH]=(0,i.useState)(!1),[eO,eR]=(0,i.useState)(!1),[eV,eJ]=(0,i.useState)(""),eq=["Details","Prices","Entitlements","Review"];(0,i.useEffect)(()=>(e.setHeader({breadcrumb:"Admin / Billing",title:"Plan builder",subtitle:"Build a plan and create it at the end",actions:(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(a.default,{href:"/admin/billing/plans",children:(0,t.jsx)(d.Button,{variant:"outline",size:"sm",children:"Back to plans"})}),(0,t.jsx)(d.Button,{variant:"outline",size:"sm",onClick:()=>B(e=>e+1),disabled:w,children:"Refresh"})]})}),()=>e.setHeader(null)),[e,w]),(0,i.useEffect)(()=>{try{let e=window.localStorage.getItem(p);if(!e)return;let t=JSON.parse(e);if(!t||"object"!=typeof t||1!==t.v)return;let i=t.plan&&"object"==typeof t.plan?t.plan:null;i&&(Q("string"==typeof i.name?i.name:""),Z("string"==typeof i.code?i.code:""),et("string"==typeof i.description?i.description:""),ea("boolean"!=typeof i.active||i.active)),Array.isArray(t.prices)&&D(t.prices.filter(e=>e&&"object"==typeof e).map(e=>e2(e)));let a=t.entitlements&&"object"==typeof t.entitlements?t.entitlements:null;a&&(ez(a.enabled&&"object"==typeof a.enabled?a.enabled:{}),eM(a.value&&"object"==typeof a.value?a.value:{}),eE(a.jsonText&&"object"==typeof a.jsonText?a.jsonText:{})),"number"==typeof t.step&&Number.isFinite(t.step)&&N(Math.max(0,Math.min(eq.length-1,Math.trunc(t.step))))}catch{try{window.localStorage.removeItem(p)}catch{}}},[eq.length]),(0,i.useEffect)(()=>{let e=!0;return async function(){try{C(!0),S(null),A(null);let t=await (0,v.getBillingCatalog)({includeInactive:!0});if(!e)return;let i=Array.isArray(t.entitlement_definitions)?t.entitlement_definitions:[];T(i);let a=Array.isArray(t.billing_intervals)?t.billing_intervals:[];I(a);try{let t=await (0,h.apiFetch)("/api/admin/settings");if(!e)return;let i=(Array.isArray(t.currencies)?t.currencies:[]).filter(e=>!!e?.is_active).map(e=>({code:String(e.code??"").trim().toUpperCase(),name:String(e.name??"").trim(),symbol:String(e.symbol??"").trim()})).filter(e=>3===e.code.length).sort((e,t)=>e.code.localeCompare(t.code));$(i)}catch(t){if(!e)return;$([])}}catch(t){if(!e)return;S(t instanceof Error?t.message:"Failed to load billing catalog."),T([]),I([]),$([])}finally{if(!e)return;C(!1)}}(),()=>{e=!1}},[z]);let eK=(0,i.useMemo)(()=>new Set(F.map(e=>e.code)),[F]),eX=(0,i.useMemo)(()=>[],[]),eW=(0,i.useMemo)(()=>({}),[eX]),eG=(0,i.useMemo)(()=>(Array.isArray(M)?M:[]).slice().sort((e,t)=>(e.id??0)-(t.id??0)),[M]);(0,i.useEffect)(()=>{let e={},t={},i={},a={};for(let n of eG){let s=eW[n.id]??null;e[n.id]=!!s,t[n.id]=s?s.value_json:null;let l=String(n.value_type??"json");"boolean"===l&&s&&(t[n.id]=!0),"boolean"!==l&&"integer"!==l&&(i[n.id]=JSON.stringify(s?s.value_json??null:null,null,2),a[n.id]=null)}ez(e),eM(t),eE(i),eF(a)},[eG,eW]),(0,i.useMemo)(()=>{let e=[];for(let t of eG){if(!eA[t.id])continue;let i=String(t.value_type??"json");e.push({entitlement_definition_id:t.id,value_json:"boolean"===i||(eB[t.id]??null)})}return{plan:{name:G.trim(),code:Y.trim()||null,description:ee.trim()||null,is_active:!!ei},prices:P.map(e=>({currency:String(e.currency).toUpperCase(),interval:String(e.interval).toLowerCase(),amount_cents:e.amount_cents,trial_days:e.trial_days,is_default:!!e.is_default})),entitlements:e}},[eG,eA,eB,ei,Y,ee,G,P]);let eQ=(0,i.useMemo)(()=>{let e=(Array.isArray(P)?P:[]).map(e=>({...e,currency:String(e.currency).trim().toUpperCase(),interval:String(e.interval||"").trim().toLowerCase()||"month",billing_interval_id:"number"==typeof e.billing_interval_id&&Number.isFinite(e.billing_interval_id)?e.billing_interval_id:null,amount_cents:Number.isFinite(e.amount_cents)?Math.max(0,Math.trunc(e.amount_cents)):0}));if(0===e.length)return{ok:!1,message:"Add at least one price."};let t={};for(let i of e){let e=`${i.currency}|${i.interval}`;t[e]||(t[e]={total:0,defaults:0}),t[e].total+=1,i.is_default&&(t[e].defaults+=1)}for(let[e,i]of Object.entries(t)){if(0===i.defaults)return{ok:!1,message:`Set a default price for ${e}.`};if(i.defaults>1)return{ok:!1,message:`Only one default price allowed for ${e}.`}}return{ok:!0,message:null}},[P]),eY=(0,i.useMemo)(()=>0===G.trim().length?0:eQ.ok?eq.length-1:1,[G,eQ.ok,eq.length]);async function eZ(){(2!==y||!K||await e6())&&N(e=>Math.min(e+1,eY))}function e0(){ec(null),eu(null),ex(F[0]?.code??"EUR"),ev(null),ep("month"),eg("0.00"),ey(""),ew(!0)}function e1(e,t){return`${String(e).trim().toUpperCase()}|${String(t||"").trim().toLowerCase()||"month"}`}function e2(e){return{...e,currency:String(e.currency).trim().toUpperCase(),interval:String(e.interval||"").trim().toLowerCase()||"month",billing_interval_id:"number"==typeof e.billing_interval_id&&Number.isFinite(e.billing_interval_id)?e.billing_interval_id:null,amount_cents:Number.isFinite(e.amount_cents)?Math.max(0,Math.trunc(e.amount_cents)):0,trial_days:"number"==typeof e.trial_days&&Number.isFinite(e.trial_days)?Math.max(0,Math.trunc(e.trial_days)):null,is_default:!!e.is_default}}async function e3(){if(!K||R)return null;let e=G.trim();if(!e)return W("Name is required."),N(0),null;if(!eQ.ok)return A(eQ.message??"Invalid prices."),N(1),null;V(!0),q(null),A(null);try{let t=(await (0,v.createBillingPlan)({name:e,code:Y.trim()||void 0,description:ee.trim()||void 0,isActive:ei})).plan,i=(Array.isArray(t.versions)?t.versions:[]).filter(e=>"draft"===String(e.status).toLowerCase()).slice().sort((e,t)=>(t.version??0)-(e.version??0))[0]??null;if(!i)throw Error("Plan created but no draft version was returned.");U(t),O(i);let a=i;for(let e of function(e){let t=e.slice(),i={};for(let e of t){if(!e.is_default)continue;let t=`${e.currency}|${e.interval}`;i[t]=(i[t]??0)+1,i[t]>1&&(e.is_default=!1)}return t}(P.map(e2))){let t=await (0,v.createBillingPrice)({versionId:a.id,currency:e.currency,interval:e.interval,billingIntervalId:e.billing_interval_id,amountCents:e.amount_cents,trialDays:e.trial_days,isDefault:e.is_default});a=t.version,O(t.version)}let n=[];for(let e of eG){if(!eA[e.id])continue;let t=String(e.value_type??"json");if("boolean"===t){n.push({entitlement_definition_id:e.id,value_json:!0});continue}if("boolean"!==t&&"integer"!==t){let t=eT[e.id]??"",i=""===t.trim()?{}:JSON.parse(t);n.push({entitlement_definition_id:e.id,value_json:i});continue}let i=eB[e.id],a="number"==typeof i&&Number.isFinite(i)?Math.trunc(i):0;n.push({entitlement_definition_id:e.id,value_json:a})}let s=await (0,v.syncBillingPlanVersionEntitlements)({versionId:a.id,entitlements:n});O(s.version),eL(null),B(e=>e+1);try{window.localStorage.removeItem(p)}catch{}return s.version}catch(e){return q(e instanceof Error?e.message:"Failed to create plan."),null}finally{V(!1)}}async function e5(){if(K&&!el){er(!0),ec(null),A(null);try{var e;let t,i,a,n=em.trim().toUpperCase();if(3!==n.length)return void ec("Currency is required.");if(eK.size>0&&!eK.has(n))return void ec("Currency must be one of the allowed currencies.");let s="number"==typeof eh&&Number.isFinite(eh)?eh:null,l=String(ef||"").trim().toLowerCase();if(!s&&!l)return void ec("Interval is required.");let r=(t=Number.parseFloat(eb.trim().replace(",",".")),!Number.isFinite(t)||t<0?0:Math.round(100*t)),d=""===ej.trim()?null:Number(ej),c="number"==typeof d&&Number.isFinite(d)?Math.max(0,Math.trunc(d)):null,o=(e={currency:n,interval:l||"month",ignoreKey:eo},i=e1(e.currency,e.interval),a=(Array.isArray(P)?P:[]).map(e2).filter(t=>!e.ignoreKey||t.key!==e.ignoreKey).filter(e=>e1(e.currency,e.interval)===i),0===a.length||!a.some(e=>!!e.is_default)),u={key:eo??`${Date.now()}_${Math.random().toString(16).slice(2)}`,currency:n,interval:l||"month",billing_interval_id:s,amount_cents:r,trial_days:c,is_default:!!(eN||o)};D(e=>{let t=e2(u),i=e.some(e=>e.key===t.key)?e.map(e=>e.key===t.key?t:e):[...e,t];return t.is_default?i.map(e=>e.key===t.key?e:`${e.currency}|${e.interval}`==`${t.currency}|${t.interval}`?{...e,is_default:!1}:e):i}),es(!1)}catch(e){ec(e instanceof Error?e.message:"Failed to save price.")}finally{er(!1)}}}async function e6(){if(!K)return!0;if(eC)return!1;e_(!0),A(null),ek(null);try{if(!H)return ek("Saved locally. These entitlements will be applied when you create the plan."),!0;let e=[];for(let t of eG){if(!eA[t.id])continue;let i=String(t.value_type??"json");if("boolean"===i){e.push({entitlement_definition_id:t.id,value_json:!0});continue}if("boolean"!==i&&"integer"!==i){let i=eT[t.id]??"";try{let a=""===i.trim()?{}:JSON.parse(i);e.push({entitlement_definition_id:t.id,value_json:a}),eF(e=>({...e,[t.id]:null}))}catch{return eF(e=>({...e,[t.id]:"Invalid JSON."})),!1}continue}let a=eB[t.id],n="number"==typeof a&&Number.isFinite(a)?Math.trunc(a):0;e.push({entitlement_definition_id:t.id,value_json:n})}let t=await (0,v.syncBillingPlanVersionEntitlements)({versionId:H.id,entitlements:e});return O(t.version),ek("Entitlements saved."),eL(null),!0}catch(e){return A(e instanceof Error?e.message:"Failed to save entitlements."),!1}finally{e_(!1)}}async function e7(e){let t=e??H;if(!t)return null;eP(!0),eL(null),A(null);try{let e=await (0,v.validateBillingPlanVersionDraft)({versionId:t.id}),i="status"in e&&"ok"===e.status,a="errors"in e&&Array.isArray(e.errors)?e.errors.map(String):[],n={ok:i,errors:a};return eL(n),n}catch(e){return A(e instanceof Error?e.message:"Failed to validate."),null}finally{eP(!1)}}async function e4(){if(!K||R||e$)return;let e=H;e||(e=await e3()),e&&await e7(e)}async function e9(){if(H&&K&&!eO){eR(!0),A(null);try{let e=await (0,v.activateBillingPlanVersion)({versionId:H.id,confirm:eV.trim()});O(e.version),eH(!1),eJ(""),B(e=>e+1),eL(null)}catch(e){A(e instanceof Error?e.message:"Failed to activate.")}finally{eR(!1)}}}(0,i.useEffect)(()=>{N(e=>Math.min(e,eY))},[eY]),(0,i.useEffect)(()=>{if(!L)try{let e={v:1,step:y,plan:{name:G,code:Y,description:ee,active:!!ei},prices:Array.isArray(P)?P:[],entitlements:{enabled:eA,value:eB,jsonText:eT}};window.localStorage.setItem(p,JSON.stringify(e))}catch{}},[L,eA,eT,eB,ei,Y,ee,G,P,y]);let e8=!!(H&&"active"===String(H.status).toLowerCase()),te=!!(R||e$);return(0,t.jsx)(n.RequireAuth,{requiredPermission:"admin.billing.read",children:(0,t.jsxs)("div",{className:"space-y-6",children:[_?(0,t.jsx)(l.Alert,{variant:"danger",title:"Could not load billing catalog",children:_}):null,k?(0,t.jsx)(l.Alert,{variant:"danger",title:"Action failed",children:k}):null,(0,t.jsxs)("div",{className:"grid gap-6 lg:grid-cols-[260px_1fr]",children:[(0,t.jsx)(g,{steps:eq,step:y,maxStepAllowed:eY,onStepChange:N}),(0,t.jsxs)("div",{className:"space-y-6",children:[0===y?(0,t.jsxs)(c.Card,{children:[(0,t.jsx)(c.CardHeader,{children:(0,t.jsx)(c.CardTitle,{children:"Plan details"})}),(0,t.jsxs)(c.CardContent,{className:"space-y-4",children:[(0,t.jsx)("div",{className:"rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-[var(--rb-surface-muted)] p-3 text-sm text-zinc-700",children:"Configure the plan here and click Next. The plan will be created on the Review step."}),X?(0,t.jsx)(l.Alert,{variant:"danger",title:"Cannot save plan",children:X}):null,(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)("label",{className:"text-sm font-medium",children:"Name"}),(0,t.jsx)(m.Input,{value:G,onChange:e=>Q(e.target.value),disabled:w||R})]}),(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)("label",{className:"text-sm font-medium",children:"Code"}),(0,t.jsx)(m.Input,{value:Y,onChange:e=>Z(e.target.value),disabled:w||R}),(0,t.jsx)("div",{className:"text-xs text-zinc-500",children:"Leave blank to auto-generate from name."})]}),(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)("label",{className:"text-sm font-medium",children:"Description"}),(0,t.jsx)("textarea",{className:"min-h-[90px] w-full rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white px-3 py-2 text-sm",value:ee,onChange:e=>et(e.target.value),disabled:w||R})]}),(0,t.jsxs)("label",{className:"flex items-center gap-2 text-sm",children:[(0,t.jsx)("input",{type:"checkbox",checked:ei,onChange:e=>ea(e.target.checked),disabled:w||R}),"Active"]}),(0,t.jsxs)("div",{className:"text-xs text-zinc-500",children:["Need to edit existing plans? Use ",(0,t.jsx)(a.default,{className:"underline",href:"/admin/billing/plans",children:"Billing plans"}),"."]})]})]}):null,1===y?(0,t.jsxs)(c.Card,{children:[(0,t.jsxs)(c.CardHeader,{className:"flex flex-row items-start justify-between gap-4",children:[(0,t.jsxs)("div",{className:"min-w-0",children:[(0,t.jsx)(c.CardTitle,{children:"Prices"}),(0,t.jsx)("div",{className:"mt-1 text-sm text-zinc-600",children:"Configure price points per currency + interval, including defaults."})]}),K?(0,t.jsx)(d.Button,{variant:"secondary",size:"sm",onClick:()=>{e0(),es(!0)},disabled:w||el,children:"Add price"}):null]}),(0,t.jsxs)(c.CardContent,{children:[eQ.message?(0,t.jsx)(l.Alert,{variant:"warning",title:"Prices",children:eQ.message}):null,(0,t.jsx)(u.DataTable,{title:"Price points",data:P,loading:w,emptyMessage:"No prices configured.",getRowId:e=>e.key,columns:[{id:"pair",header:"Currency / interval",cell:e=>(0,t.jsxs)("div",{className:"text-sm text-zinc-800",children:[String(e.currency).toUpperCase()," / ",String(e.interval).toLowerCase()]}),className:"whitespace-nowrap"},{id:"amount",header:"Amount",cell:e=>(0,t.jsx)("div",{className:"text-sm text-zinc-700",children:b(e.amount_cents??0,e.currency)}),className:"whitespace-nowrap"},{id:"trial",header:"Trial",cell:e=>(0,t.jsx)("div",{className:"text-sm text-zinc-700",children:"number"==typeof e.trial_days?`${e.trial_days} days`:"—"}),className:"whitespace-nowrap"},{id:"default",header:"Default",cell:e=>e.is_default?(0,t.jsx)(r.Badge,{variant:"success",children:"default"}):(0,t.jsx)(r.Badge,{variant:"default",children:"—"}),className:"whitespace-nowrap"},{id:"actions",header:"",cell:e=>K?(0,t.jsxs)("div",{className:"flex items-center justify-end gap-2",children:[(0,t.jsx)(d.Button,{variant:"outline",size:"sm",onClick:()=>{e0(),eu(e.key),ex(String(e.currency).toUpperCase()),ev("number"==typeof e.billing_interval_id?e.billing_interval_id:null),ep(String(e.interval||"").toLowerCase()||"month"),eg(((e.amount_cents??0)/100).toFixed(2)),ey("number"==typeof e.trial_days?String(e.trial_days):""),ew(!!e.is_default),es(!0)},disabled:el,children:"Edit"}),(0,t.jsx)(d.Button,{variant:"outline",size:"sm",onClick:()=>{var t;return t=e.key,void D(e=>e.filter(e=>e.key!==t))},disabled:el,children:"Delete"})]}):null,className:"whitespace-nowrap"}]})]})]}):null,2===y?(0,t.jsxs)(c.Card,{children:[(0,t.jsx)(c.CardHeader,{children:(0,t.jsx)(c.CardTitle,{children:"Entitlements"})}),(0,t.jsxs)(c.CardContent,{className:"space-y-3",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between gap-3",children:[(0,t.jsx)("div",{className:"text-sm text-zinc-600",children:"Toggle features/limits and configure values per type."}),K?(0,t.jsx)(d.Button,{variant:"secondary",size:"sm",onClick:()=>void e6(),disabled:eC,children:eC?"Saving…":"Save entitlements"}):null]}),eS?(0,t.jsx)(l.Alert,{variant:"success",title:"Entitlements",children:eS}):null,0===eG.length?(0,t.jsx)(l.Alert,{variant:"warning",title:"No entitlements",children:"Create entitlement definitions first."}):null,eG.map(e=>{let i=!!eA[e.id],a=eB[e.id],n=String(e.value_type??"json"),s=eI[e.id]??null;return(0,t.jsxs)("div",{className:`rounded-[var(--rb-radius-sm)] border p-3 ${i?"border-[color:color-mix(in_srgb,var(--rb-blue),white_55%)] bg-white":"border-[var(--rb-border)] bg-[var(--rb-surface-muted)]"}`,children:[(0,t.jsxs)("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between",children:[(0,t.jsxs)("div",{className:"min-w-0",children:[(0,t.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[(0,t.jsx)("div",{className:"text-sm font-semibold text-zinc-900",children:e.name}),(0,t.jsx)(r.Badge,{variant:i?"success":"default",children:i?"Enabled":"Disabled"}),(0,t.jsx)(r.Badge,{variant:"info",children:n}),e.is_premium?(0,t.jsx)(r.Badge,{variant:"warning",children:"premium"}):null]}),(0,t.jsx)("div",{className:"mt-1 text-xs text-zinc-500 font-mono",children:e.code}),e.description?(0,t.jsx)("div",{className:"mt-2 text-sm text-zinc-600",children:e.description}):null]}),(0,t.jsx)("div",{className:"flex items-center justify-between gap-3 sm:flex-col sm:items-end",children:(0,t.jsxs)("label",{className:"flex items-center gap-2 text-sm font-medium",children:[(0,t.jsx)("input",{type:"checkbox",checked:i,disabled:!K,onChange:t=>{let i=t.target.checked;ez(t=>({...t,[e.id]:i})),i&&"boolean"===n&&eM(t=>({...t,[e.id]:!0}))}}),"Enable"]})})]}),i?(0,t.jsx)("div",{className:"mt-3 rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white p-3",children:"boolean"===n?(0,t.jsx)("div",{className:"text-sm text-zinc-700",children:"Feature enabled."}):"integer"===n?(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)("label",{className:"text-sm font-medium",children:"Limit"}),(0,t.jsx)(m.Input,{type:"number",value:null==a?"":String(a),disabled:!K,onChange:t=>{let i=t.target.value;if(""===i.trim())return void eM(t=>({...t,[e.id]:null}));let a=Number(i);Number.isFinite(a)&&eM(t=>({...t,[e.id]:Math.trunc(a)}))}}),(0,t.jsx)("div",{className:"text-xs text-zinc-500",children:"Use a whole number (e.g. 10, 100, 1000)."})]}):(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)("label",{className:"text-sm font-medium",children:"Value (JSON)"}),(0,t.jsx)("textarea",{className:"min-h-[110px] w-full rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white px-3 py-2 font-mono text-sm",value:eT[e.id]??"",disabled:!K,onChange:t=>{eE(i=>({...i,[e.id]:t.target.value})),eF(t=>({...t,[e.id]:null}))}}),s?(0,t.jsx)("div",{className:"text-xs text-red-600",children:s}):null]})}):null]},e.id)})]})]}):null,3===y?(0,t.jsxs)(c.Card,{children:[(0,t.jsxs)(c.CardHeader,{className:"flex flex-row items-start justify-between gap-4",children:[(0,t.jsxs)("div",{className:"min-w-0",children:[(0,t.jsx)(c.CardTitle,{children:"Review"}),(0,t.jsx)("div",{className:"mt-1 text-sm text-zinc-600",children:"Create the plan from your configuration, then validate/activate the draft."})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(a.default,{href:"/admin/billing/plans",children:(0,t.jsx)(d.Button,{variant:"outline",size:"sm",children:"Back to plans"})}),(0,t.jsx)(d.Button,{variant:"secondary",size:"sm",onClick:()=>eH(!0),disabled:!K||eO||e8||!eD?.ok,children:e8?"Activated":"Activate"})]})]}),(0,t.jsxs)(c.CardContent,{className:"space-y-4",children:[J?(0,t.jsx)(l.Alert,{variant:"danger",title:"Create failed",children:J}):null,(0,t.jsxs)("div",{className:"rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white p-3",children:[(0,t.jsx)("div",{className:"text-sm font-semibold text-zinc-900",children:"Next actions"}),(0,t.jsxs)("div",{className:"mt-2 space-y-2",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between gap-3",children:[(0,t.jsx)("div",{className:"text-sm text-zinc-700",children:"1. Save & validate"}),e8||eD?.ok?(0,t.jsx)(r.Badge,{variant:"success",children:"done"}):te?(0,t.jsx)(r.Badge,{variant:"info",children:"running"}):(0,t.jsx)(r.Badge,{variant:"default",children:"pending"})]}),(0,t.jsxs)("div",{className:"flex items-center justify-between gap-3",children:[(0,t.jsx)("div",{className:"text-sm text-zinc-700",children:"2. Activate"}),e8?(0,t.jsx)(r.Badge,{variant:"success",children:"active"}):eD?.ok?(0,t.jsx)(r.Badge,{variant:"default",children:"ready"}):(0,t.jsx)(r.Badge,{variant:"default",children:"locked"})]})]})]}),L&&H?(0,t.jsxs)(l.Alert,{variant:"success",title:"Plan created",children:["Plan ",(0,t.jsx)("span",{className:"font-mono",children:L.code})," created. Draft version id ",H.id,"."]}):(0,t.jsx)(l.Alert,{variant:"info",title:"Not saved yet",children:"Click Save & validate to persist this configuration."}),e8?(0,t.jsx)(l.Alert,{variant:"success",title:"Activated",children:"This plan version is active."}):eD?eD.ok?(0,t.jsx)(l.Alert,{variant:"success",title:"Validation passed",children:"This draft version is ready to activate."}):(0,t.jsx)(l.Alert,{variant:"warning",title:"Validation failed",children:(0,t.jsx)("div",{className:"space-y-1",children:eD.errors.map((e,i)=>(0,t.jsx)("div",{children:e},i))})}):(0,t.jsx)(l.Alert,{variant:"info",title:"Not validated",children:"Click Save & validate to run server-side checks."}),(0,t.jsxs)("div",{className:"grid grid-cols-1 gap-4 lg:grid-cols-3",children:[(0,t.jsxs)(c.Card,{className:"lg:col-span-1",children:[(0,t.jsx)(c.CardHeader,{children:(0,t.jsx)(c.CardTitle,{children:"Plan"})}),(0,t.jsxs)(c.CardContent,{className:"space-y-3",children:[(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)("div",{className:"text-xs font-medium uppercase tracking-wide text-zinc-500",children:"Name"}),(0,t.jsx)("div",{className:"text-sm font-semibold text-zinc-900",children:G.trim()||"—"})]}),(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)("div",{className:"text-xs font-medium uppercase tracking-wide text-zinc-500",children:"Code"}),(0,t.jsx)("div",{className:"text-sm text-zinc-700",children:Y.trim()?(0,t.jsx)("span",{className:"font-mono",children:Y.trim()}):(0,t.jsx)("span",{className:"text-zinc-500",children:"auto-generated"})})]}),(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)("div",{className:"text-xs font-medium uppercase tracking-wide text-zinc-500",children:"Status"}),(0,t.jsx)("div",{children:ei?(0,t.jsx)(r.Badge,{variant:"success",children:"active"}):(0,t.jsx)(r.Badge,{variant:"default",children:"inactive"})})]}),(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)("div",{className:"text-xs font-medium uppercase tracking-wide text-zinc-500",children:"Description"}),(0,t.jsx)("div",{className:"text-sm text-zinc-700 whitespace-pre-wrap",children:ee.trim()||"—"})]})]})]}),(0,t.jsxs)(c.Card,{className:"lg:col-span-2",children:[(0,t.jsx)(c.CardHeader,{children:(0,t.jsx)(c.CardTitle,{children:"Prices"})}),(0,t.jsx)(c.CardContent,{children:(0,t.jsx)(u.DataTable,{title:"Price points",data:(Array.isArray(P)?P:[]).slice().map(e=>e2(e)).sort((e,t)=>`${e.currency}|${e.interval}`.localeCompare(`${t.currency}|${t.interval}`)),loading:!1,emptyMessage:"No prices configured.",getRowId:e=>e.key,columns:[{id:"currency",header:"Currency",cell:e=>{let i=String(e.currency).toUpperCase(),a=F.find(e=>e.code===i)??null;return(0,t.jsxs)("div",{className:"space-y-0.5",children:[(0,t.jsx)("div",{className:"text-sm font-medium text-zinc-900",children:i}),a?.name?(0,t.jsx)("div",{className:"text-xs text-zinc-500",children:a.name}):null]})},className:"whitespace-nowrap"},{id:"interval",header:"Interval",cell:e=>(0,t.jsx)("div",{className:"text-sm text-zinc-700",children:String(e.interval).toLowerCase()}),className:"whitespace-nowrap"},{id:"amount",header:"Amount",cell:e=>(0,t.jsx)("div",{className:"text-sm text-zinc-800",children:b(e.amount_cents??0,e.currency)}),className:"whitespace-nowrap"},{id:"trial",header:"Trial",cell:e=>(0,t.jsx)("div",{className:"text-sm text-zinc-700",children:"number"==typeof e.trial_days?`${e.trial_days} days`:"—"}),className:"whitespace-nowrap"},{id:"default",header:"Default",cell:e=>e.is_default?(0,t.jsx)(r.Badge,{variant:"success",children:"default"}):(0,t.jsx)(r.Badge,{variant:"default",children:"—"}),className:"whitespace-nowrap"}]})})]})]}),(0,t.jsxs)(c.Card,{children:[(0,t.jsx)(c.CardHeader,{children:(0,t.jsx)(c.CardTitle,{children:"Entitlements"})}),(0,t.jsx)(c.CardContent,{children:0===eG.filter(e=>!!eA[e.id]).length?(0,t.jsx)("div",{className:"text-sm text-zinc-600",children:"No entitlements enabled."}):(0,t.jsx)("div",{className:"space-y-2",children:eG.filter(e=>!!eA[e.id]).map(e=>{let i=String(e.value_type??"json"),a=eB[e.id],n="—";return n="boolean"===i?a?"Enabled":"Disabled":"integer"===i?"number"==typeof a?String(a):null===a?"—":String(a):(eT[e.id]??"").trim()?"Custom":"—",(0,t.jsxs)("div",{className:"flex flex-col gap-2 rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white p-3 sm:flex-row sm:items-center sm:justify-between",children:[(0,t.jsxs)("div",{className:"min-w-0",children:[(0,t.jsxs)("div",{className:"text-sm font-semibold text-zinc-900",children:[e.name," ",(0,t.jsxs)("span",{className:"text-xs font-normal text-zinc-500",children:["(",e.code,")"]})]}),(0,t.jsxs)("div",{className:"mt-0.5 text-xs text-zinc-500",children:["Type: ",i]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[e.is_premium?(0,t.jsx)(r.Badge,{variant:"warning",children:"premium"}):null,(0,t.jsx)(r.Badge,{variant:"info",children:n})]})]},e.id)})})})]})]})]}):null,(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)(d.Button,{variant:"outline",onClick:function(){N(e=>Math.max(e-1,0))},disabled:0===y,children:"Back"}),(0,t.jsxs)("div",{className:"flex items-center justify-between gap-4",children:[(0,t.jsxs)("div",{className:"text-sm text-zinc-500",children:["Step ",y+1," of ",eq.length]}),(0,t.jsx)(d.Button,{variant:"primary",onClick:()=>{if(y!==eq.length-1)return void eZ();if(K&&!e8){if(!eD?.ok)return void e4();eH(!0)}},disabled:y>eY||2===y&&eC||y===eq.length-1&&(!K||eO||e8||!eD?.ok&&te),children:y===eq.length-1?e8?"Activated":eD?.ok?eO?"Activating…":"Activate":te?"Saving & validating…":"Save & validate":"Next"})]})]})]})]}),(0,t.jsx)(x.Modal,{open:en,onClose:()=>{el||es(!1)},title:eo?"Edit price":"Add price",footer:(0,t.jsxs)("div",{className:"flex items-center justify-end gap-2",children:[(0,t.jsx)(d.Button,{variant:"outline",onClick:()=>el?null:es(!1),disabled:el,children:"Cancel"}),(0,t.jsx)(d.Button,{variant:"primary",onClick:()=>void e5(),disabled:el,children:el?"Saving…":"Save"})]}),children:(0,t.jsxs)("div",{className:"space-y-4",children:[ed?(0,t.jsx)(l.Alert,{variant:"danger",title:"Cannot save price",children:ed}):null,(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)("label",{className:"text-sm font-medium",children:"Currency"}),(0,t.jsxs)("select",{className:"w-full rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white px-3 py-2 text-sm",value:em,onChange:e=>ex(e.target.value),disabled:el||!!eo||0===F.length,children:[0===F.length?(0,t.jsx)("option",{value:em,children:em}):null,F.map(e=>(0,t.jsxs)("option",{value:e.code,children:[e.code,e.name?` — ${e.name}`:""]},e.code))]}),0===F.length?(0,t.jsx)("div",{className:"text-xs text-zinc-500",children:"No allowed currencies found. Add currencies under Admin / Billing / Currencies."}):null]}),(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)("label",{className:"text-sm font-medium",children:"Interval"}),E.length>0?(0,t.jsxs)("select",{className:"w-full rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white px-3 py-2 text-sm",value:eh??"",onChange:e=>{let t=e.target.value,i=t?Number(t):null,a=E.find(e=>e.id===i)??null;ev(a?a.id:null),ep(a?String(a.code).toLowerCase():"")},disabled:el||!!eo,children:[(0,t.jsx)("option",{value:"",children:"Select interval"}),E.slice().sort((e,t)=>(e.months??0)-(t.months??0)||String(e.name).localeCompare(String(t.name))).map(e=>(0,t.jsxs)("option",{value:e.id,children:[e.name," (",e.months," months)"]},e.id))]}):(0,t.jsxs)("select",{className:"w-full rounded-[var(--rb-radius-sm)] border border-[var(--rb-border)] bg-white px-3 py-2 text-sm",value:ef,onChange:e=>ep("year"===e.target.value?"year":"month"),disabled:el||!!eo,children:[(0,t.jsx)("option",{value:"month",children:"month"}),(0,t.jsx)("option",{value:"year",children:"year"})]}),eo?(0,t.jsx)("div",{className:"text-xs text-zinc-500",children:"Currency and interval are immutable for an existing price."}):null]}),(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)("label",{className:"text-sm font-medium",children:"Amount"}),(0,t.jsx)(m.Input,{value:eb,onChange:e=>eg(e.target.value),disabled:el})]}),(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)("label",{className:"text-sm font-medium",children:"Trial days (optional)"}),(0,t.jsx)(m.Input,{value:ej,onChange:e=>ey(e.target.value),disabled:el})]}),(0,t.jsxs)("label",{className:"flex items-center gap-2 text-sm",children:[(0,t.jsx)("input",{type:"checkbox",checked:eN,onChange:e=>ew(e.target.checked),disabled:el}),"Default for this currency + interval"]})]})}),(0,t.jsx)(o.ConfirmDialog,{open:eU,title:"Activate",message:(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsx)("div",{children:"This will activate the selected draft version and automatically retire the current active version (if any)."}),(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)("label",{className:"text-sm font-medium",children:"Type ACTIVATE to confirm"}),(0,t.jsx)(m.Input,{value:eV,onChange:e=>eJ(e.target.value)})]})]}),confirmText:"Activate",confirmVariant:"secondary",busy:eO,onCancel:()=>eH(!1),onConfirm:()=>{e9()}})]})})}e.s(["default",()=>j])}]);